!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@iota/iota.js"),require("big-integer")):"function"==typeof define&&define.amd?define(["exports","@iota/iota.js","big-integer"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Mam={},t.Iota,t.bigInt)}(this,(function(t,e,r){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=n(r);class o{static encodeNonASCII(t){return"string"==typeof t?t.replace(/[\u007F-\uFFFF]/g,(t=>`\\u${`0000${t.charCodeAt(0).toString(16)}`.slice(-4)}`)):void 0}static decodeNonASCII(t){return"string"==typeof t?t.replace(/\\u(\w{4})/gi,((t,e)=>String.fromCharCode(Number.parseInt(e,16)))):void 0}}class i{static isHash(t){return/^[9A-Z]{81}$/.test(t)}static isTag(t){return/^[9A-Z]{27}$/.test(t)}static isTrytes(t){return/^[9A-Z]+$/.test(t)}static toTrits(t){const e=new Int8Array(3*t.length);for(let r=0;r<t.length;r++){const n=i.ALPHABET.indexOf(t.charAt(r));e[3*r]=i.TRYTES_TRITS[n][0],e[3*r+1]=i.TRYTES_TRITS[n][1],e[3*r+2]=i.TRYTES_TRITS[n][2]}return e}static fromTrits(t){let e="";for(let r=0;r<t.length;r+=3)for(let n=0;n<i.ALPHABET.length;n++)if(i.TRYTES_TRITS[n][0]===t[r]&&i.TRYTES_TRITS[n][1]===t[r+1]&&i.TRYTES_TRITS[n][2]===t[r+2]){e+=i.ALPHABET.charAt(n);break}return e}static tritsValue(t){let e=0;for(let r=t.length-1;r>=0;r--)e=3*e+t[r];return e}static fromAscii(t){let e="";for(let r=0;r<t.length;r++){const n=t.charCodeAt(r),s=n%27,o=(n-s)/27;e+=i.ALPHABET[s]+i.ALPHABET[o]}return e}static toAscii(t){const e=t;if(e.length%2==1)throw new Error("The trytes length must be an even number");let r="";for(let t=0;t<e.length;t+=2){const n=i.ALPHABET.indexOf(e[t])+27*i.ALPHABET.indexOf(e[t+1]);r+=String.fromCharCode(n)}return r}static objectToTrytes(t){const e=JSON.stringify(t),r=o.encodeNonASCII(e);return r?i.fromAscii(r):""}static objectFromTrytes(t){if("string"!=typeof t)throw new TypeError("fromTrytes can only convert strings");const e=t.replace(/\9+$/,"");if(0===e.length)throw new Error("fromTrytes trytes does not contain any data");const r=i.toAscii(e),n=o.decodeNonASCII(r);return n?JSON.parse(n):void 0}static stringToTrytes(t){const e=o.encodeNonASCII(t);return e?i.fromAscii(e):""}static stringFromTrytes(t){let e=t.replace(/\9+$/,"");e.length%2==1&&(e+="9");const r=i.toAscii(e);return o.decodeNonASCII(r)}static packTrytes(t){const r=[];for(const e of t)r.push(i.ALPHABET.indexOf(e).toString(2).padStart(5,"0"));let n=r.join("");const s=n.length%8;return s>0&&(n+="1".repeat(8-s)),e.Converter.binaryToBytes(n)}static unpackTrytes(t){const r=e.Converter.bytesToBinary(t),n=[];for(let t=0;t<r.length;t+=5){const e=r.slice(t,t+5);if(e.length<5||"111111"===e)break;n.push(i.ALPHABET[Number.parseInt(e,2)])}return n.join("")}}i.ALPHABET="9ABCDEFGHIJKLMNOPQRSTUVWXYZ",i.TRYTES_TRITS=[new Int8Array([0,0,0]),new Int8Array([1,0,0]),new Int8Array([-1,1,0]),new Int8Array([0,1,0]),new Int8Array([1,1,0]),new Int8Array([-1,-1,1]),new Int8Array([0,-1,1]),new Int8Array([1,-1,1]),new Int8Array([-1,0,1]),new Int8Array([0,0,1]),new Int8Array([1,0,1]),new Int8Array([-1,1,1]),new Int8Array([0,1,1]),new Int8Array([1,1,1]),new Int8Array([-1,-1,-1]),new Int8Array([0,-1,-1]),new Int8Array([1,-1,-1]),new Int8Array([-1,0,-1]),new Int8Array([0,0,-1]),new Int8Array([1,0,-1]),new Int8Array([-1,1,-1]),new Int8Array([0,1,-1]),new Int8Array([1,1,-1]),new Int8Array([-1,-1,0]),new Int8Array([0,-1,0]),new Int8Array([1,-1,0]),new Int8Array([-1,0,0])];const l=27*e.Curl.HASH_LENGTH;function a(t){const r=new e.Curl(27);r.absorb(t,0,t.length);const n=new Int8Array(e.Curl.HASH_LENGTH);return r.squeeze(n,0,n.length),n}function u(t,r){const n=r*l,s=new Int8Array(n),o=new Int8Array(n),i=new e.Curl(27);i.absorb(t,0,t.length),i.squeeze(s,0,s.length);for(let t=0;t<n/e.Curl.HASH_LENGTH;t++){const r=t*e.Curl.HASH_LENGTH;i.reset(),i.absorb(s,r,e.Curl.HASH_LENGTH),o.set(i.rate(),r)}return o}function c(t,r,n){const s=function(t,r){const n=new e.Curl(27),s=t.slice();let o=r;for(;o-- >0;)for(let t=0;t<s.length&&s[t]++>=1;t++)s[t]=-1;n.absorb(s,0,s.length);const i=new Int8Array(e.Curl.HASH_LENGTH);return n.squeeze(i,0,i.length),i}(t,r);return{address:a(function(t,r){const n=new e.Curl(27),s=new e.Curl(27),o=new e.Curl(27),i=r*l/e.Curl.HASH_LENGTH,a=new Int8Array(e.Curl.HASH_LENGTH);n.absorb(t,0,t.length);for(let t=0;t<i;t++){n.squeeze(a,0,a.length);for(let t=0;t<27;t++)s.reset(),s.absorb(a,0,a.length),s.squeeze(a,0,a.length);o.absorb(a,0,a.length)}return o.squeeze(a,0,a.length),a}(s,n)),privateKey:u(s,n)}}class h{constructor(t,e,r,n){this.left=t,this.right=e,this.size=(t?t.size:0)+(e?e.size:0),this.addressTrits=r,this.privateKeyTrits=n}}class f{constructor(t,e,r,n){const s=i.toTrits(t),o=[];for(let t=0;t<r;t++){const r=c(s,e+t,n);o.push(new h(void 0,void 0,r.address,r.privateKey)),o[t].size=1}this.root=this.buildTree(o)}static root(t,r,n){const s=new e.Curl(27);let o=1;const i=Math.ceil(r.length/e.Curl.HASH_LENGTH);for(let l=0;l<i;l++){const i=r.slice(l*e.Curl.HASH_LENGTH,(l+1)*e.Curl.HASH_LENGTH);s.reset(),0==(o&n)?(s.absorb(t,0,t.length),s.absorb(i,0,i.length)):(s.absorb(i,0,i.length),s.absorb(t,0,t.length)),o<<=1,t=s.rate()}return s.rate()}getSubtree(t){var e;if(1===this.root.size)return{key:(null===(e=this.root.left)||void 0===e?void 0:e.privateKeyTrits)?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};const r=[];let n,s=this.root,o=this.root.size;if(t<o)for(;s;){if(!s.left){n=s.privateKeyTrits;break}o=s.left.size,t<o?(r.push(s.right?s.right:s.left),s=s.left):(r.push(s.left),s=s.right,t-=o)}return r.reverse(),{key:null!=n?n:new Int8Array,leaves:r}}buildTree(t){const r=[];for(let n=0;n<t.length;n+=2){const s=t[n],o=n+1<t.length?t[n+1]:void 0;let i;if(o){const t=new e.Curl(27);t.absorb(s.addressTrits,0,s.addressTrits.length),t.absorb(o.addressTrits,0,o.addressTrits.length),i=new Int8Array(e.Curl.HASH_LENGTH),t.squeeze(i,0,i.length)}else i=s.addressTrits;r.push(new h(s,o,i,void 0))}return 1===r.length?r[0]:this.buildTree(r)}}const d=new Int8Array([1,0,0,-1]);function T(t){if(0===t)return d;const e=H(A(Math.abs(t),1)),r=new Int8Array(function(t){const e=H(A(Math.abs(t),1));return e+e/3}(t));y(t,r);let n=0,s=0;for(let t=0;t<e-3;t+=3){const e=r.slice(t,t+3);if(i.tritsValue(e)>=0){n|=1<<s;for(let n=0;n<e.length;n++)r[t+n]=-e[n]}s++}const o=r.slice(e-3,e-3+e);if(i.tritsValue(o)<0){n|=1<<s;for(let t=0;t<o.length;t++)r[t+e-3]=-r[t+e-3]}const l=new Int8Array(r.length-e);y(n,l);for(let t=0;t<l.length;t++)r[e+t]=l[t];return r}function g(t){if(t.length>=d.length&&t[0]===d[0]&&t[1]===d[1]&&t[2]===d[2]&&t[3]===d[3])return{value:0,end:4};const e=w(t),r=e+e/3,n=i.tritsValue(t.slice(e,r));let s=0;for(let r=0;r<e/3;r++){const e=0!=(n>>r&1)?-i.tritsValue(t.slice(3*r,3*(r+1))):i.tritsValue(t.slice(3*r,3*(r+1)));s+=Math.pow(27,r)*e}return{value:s,end:r}}function H(t){const e=t%3;return 0===e?t:t+3-e}function A(t,e){return t<=e?1:1+A(t,1+3*e)}function w(t){return i.tritsValue(t.slice(0,3))>0?3:3+w(t.slice(3))}function y(t,e){const r=b(t,e,0);if(t>=0)return r;for(let t=0;t<e.length;t++)e[t]=-e[t];return r}function b(t,e,r){switch(t){case 0:return 0;default:let n=Math.floor(t/3),s=t%3;return s>1&&(n+=1,s=-1),e[r]=s,1+b(n,e,++r)}}class E{search(t,r,n,s){const o=this.prepareTrits(t,s);let i=Math.min(n,e.Curl.HASH_LENGTH)-s,l=0;for(;0===l;){const t=this.increment(o,s+2*i/3,s+i);i=Math.min(H(s+2*i/3+t),e.Curl.HASH_LENGTH)-s;const n={low:o.low.slice(),high:o.high.slice()};this.transform(n),l=this.check(r,n.low,n.high)}return this.trinaryGet(o.low,o.high,i,l)}prepareTrits(t,r){const n=this.tritsToBigInt(t,e.Curl.STATE_LENGTH);return n.low[r]=E.LOW_0,n.low[r+1]=E.LOW_1,n.low[r+2]=E.LOW_2,n.low[r+3]=E.LOW_3,n.high[r]=E.HIGH_0,n.high[r+1]=E.HIGH_1,n.high[r+2]=E.HIGH_2,n.high[r+3]=E.HIGH_3,n}tritsToBigInt(t,e){const r={low:[],high:[]};for(let e=0;e<t.length;e++)switch(t[e]){case 0:r.low[e]=E.MAX_VALUE,r.high[e]=E.MAX_VALUE;break;case 1:r.low[e]=E.MIN_VALUE,r.high[e]=E.MAX_VALUE;break;default:r.low[e]=E.MAX_VALUE,r.high[e]=E.MIN_VALUE}if(t.length>=e)return r;for(let n=t.length;n<e;n++)r.low[n]=E.MAX_VALUE,r.high[n]=E.MAX_VALUE;return r}increment(t,e,r){for(let n=e;n<r;n++){const s=t.low[n],o=t.high[n];if(t.low[n]=o.xor(s),t.high[n]=s,o.and(s.not()).equals(0))return r-e}return r-e+1}transform(t){let r=0;for(let n=0;n<E.ROUNDS;n++){const n={low:t.low.slice(0,e.Curl.STATE_LENGTH),high:t.high.slice(0,e.Curl.STATE_LENGTH)};for(let s=0;s<e.Curl.STATE_LENGTH;s++){const e=n.low[r],o=n.high[r];r+=r<365?364:-365;const i=n.high[r],l=n.low[r].xor(o),a=this.bitWiseNot(i),u=e.or(a).and(l);t.low[s]=this.bitWiseNot(u);const c=e.xor(i);t.high[s]=c.or(u)}}}bitWiseNot(t){return s.default(1).shiftLeft(64).subtract(s.default(1)).subtract(t)}check(t,e,r){for(let n=0;n<64;n++){let o=0;for(let i=0;i<t;i++){for(let t=243*i/3;t<243*(i+1)/3;t++){const i=s.default(1).shiftLeft(n);e[t].and(i).equals(0)?o--:r[t].and(i).equals(0)&&o++}if(0===o&&i<t-1){o=1;break}}if(0===o)return n}return 0}trinaryGet(t,e,r,n){const o=new Int8Array(r);for(let i=0;i<r;i++){const r=s.default(n),l=t[i].shiftRight(r).and(1),a=e[i].shiftRight(r).and(1);l.equals(1)&&a.equals(0)?o[i]=-1:l.equals(0)&&a.equals(1)?o[i]=1:o[i]=0}return o}}function C(t){let e=0;for(const r of t)e+=r.length;const r=new Int8Array(e);let n=0;for(const e of t)r.set(e,n),n+=e.length;return r}function I(t,e){if("public"!==t&&"private"!==t&&"restricted"!==t)throw new Error(`The mode must be public, private or restricted, it is '${t}'`);if("restricted"===t){if(!e)throw new Error("You must provide a sideKey for restricted mode");if(!i.isTrytes(e))throw new Error("The sideKey must be in trytes");if(e.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==t&&e)throw new Error("sideKey is only used in restricted mode")}function S(t){const r=new e.Curl(81);r.absorb(t,0,t.length);const n=new Int8Array(e.Curl.HASH_LENGTH);return r.squeeze(n,0,n.length),n}function _(t,r){const n=r.rate(),s=Math.ceil(t.length/e.Curl.HASH_LENGTH);for(let o=0;o<s;o++){const s=t.slice(o*e.Curl.HASH_LENGTH,(o+1)*e.Curl.HASH_LENGTH);r.absorb(s,0,s.length);const i=r.rate();for(let r=0;r<s.length;r++)t[o*e.Curl.HASH_LENGTH+r]=F(s[r],n[r]),n[r]=i[r]}return t}function L(t,r){const n=new Int8Array(t),s=Math.ceil(n.length/e.Curl.HASH_LENGTH)*e.Curl.HASH_LENGTH;let o;for(let t=0;t<s;t++){const s=t%e.Curl.HASH_LENGTH;0===s&&(o=r.rate()),o&&(n[t]=F(n[t],-o[s])),s===e.Curl.HASH_LENGTH-1&&r.absorb(n,Math.floor(t/e.Curl.HASH_LENGTH)*e.Curl.HASH_LENGTH,e.Curl.HASH_LENGTH)}return n}function F(t,e){const r=t+e;switch(r){case 2:return-1;case-2:return 1;default:return r}}function m(t,r,n){const s=i.toTrits(t),o=i.toTrits(r),a=i.toTrits(null!=n?n:"9".repeat(81)),u=g(s),c=u.value,h=g(s.slice(u.end)),d=h.value,T=u.end+h.end,H=T+e.Curl.HASH_LENGTH,A=H+d,w=new e.Curl(27);w.absorb(a,0,a.length),w.absorb(o,0,o.length),w.absorb(s,0,T);const y=L(s.slice(T,T+e.Curl.HASH_LENGTH),w),b=L(s.slice(H,H+d),w),E=L(s.slice(A,A+e.Curl.HASH_LENGTH/3),w),C=w.rate(),I=function(t){const r=t.slice(0,e.Curl.HASH_LENGTH/3);let n=0;for(let t=0;t<r.length;t++)n+=r[t];if(0===n)return 1;const s=t.slice(0,2*e.Curl.HASH_LENGTH/3);let o=0;for(let t=0;t<s.length;t++)o+=s[t];if(0===o)return 2;let i=0;for(let e=0;e<t.length;e++)i+=t[e];return 0===i?3:0}(C);if(0===I)throw new Error("Message Hash did not have a hamming weight of zero, security level is invalid");const S=L(s.slice(A+E.length),w);w.reset();const _=function(t,r){const n=new e.Curl(27),s=new Int8Array(r.length);for(let o=0;o<r.length/e.Curl.HASH_LENGTH;o++){let i=r.slice(o*e.Curl.HASH_LENGTH,(o+1)*e.Curl.HASH_LENGTH);for(let e=0;e<t[3*o]+3*t[3*o+1]+9*t[3*o+2]- -13;e++)n.reset(),n.absorb(i,0,i.length),i=n.rate();s.set(i,o*e.Curl.HASH_LENGTH)}return n.reset(),n.absorb(s,0,s.length),n.rate()}(C,S.slice(0,I*l));w.absorb(_,0,_.length);const F=g(S.slice(I*l)),m=F.value;let p=w.rate();if(0!==m){const t=I*l+F.end,r=S.slice(t,t+m*e.Curl.HASH_LENGTH);p=f.root(p,r,c)}if(i.fromTrits(p)!==r)throw new Error("Signature did not match expected root");return{nextRoot:i.fromTrits(y),message:i.fromTrits(b)}}async function p(t,r,n,s){I(n,s);const o="string"==typeof t?new e.SingleNodeClient(t):t,i=N(r,n),l=e.Blake2b.sum256(e.Converter.utf8ToBytes(i));try{const t=await o.messagesFind(l),e=[];for(const r of t.messageIds)try{const t=await o.message(r);e.push(t)}catch{}return await G(e,r,s)}catch{}}function N(t,e){return"public"===e?t:i.fromTrits(S(i.toTrits(t)))}async function G(t,r,n){var s;if(t&&0!==t.length)for(const o of t)if((null===(s=o.payload)||void 0===s?void 0:s.type)===e.INDEXATION_PAYLOAD_TYPE&&o.payload.data){const t=e.Converter.hexToBytes(o.payload.data);if(t.length>100){const e=t[0],s=e>0?t.slice(1,1+e):void 0,o=t.slice(1+e),l=s?i.unpackTrytes(s):"",a=i.unpackTrytes(o);try{return{root:r,...m(a,r,n),tag:l}}catch{}}}}E.MAX_VALUE=s.default("FFFFFFFFFFFFFFFF",16),E.MIN_VALUE=s.default("0000000000000000",16),E.HIGH_0=s.default("B6DB6DB6DB6DB6DB",16),E.HIGH_1=s.default("8FC7E3F1F8FC7E3F",16),E.HIGH_2=s.default("FFC01FFFF803FFFF",16),E.HIGH_3=s.default("003FFFFFFFFFFFFF",16),E.LOW_0=s.default("DB6DB6DB6DB6DB6D",16),E.LOW_1=s.default("F1F8FC7E3F1F8FC7",16),E.LOW_2=s.default("7FFFE00FFFFC01FF",16),E.LOW_3=s.default("FFC0000007FFFFFF",16),E.ROUNDS=27,t.TrytesHelper=i,t.channelRoot=function(t){if(!t)throw new Error("channelState must be provided");if(t.start<0)throw new Error("channelState.start must be >= 0");if(t.count<=0)throw new Error("channelState.count must be > 0");if(t.security<1||t.security>3)throw new Error(`channelState.security must be between 1 and 3, it is ${t.security}`);const e=new f(t.seed,t.start,t.count,t.security);return i.fromTrits(e.root.addressTrits)},t.createChannel=function(t,e,r,n){if(!i.isHash(t))throw new Error("The seed must be 81 trytes long");if(e<1||e>3)throw new Error(`Security must be between 1 and 3, it is ${e}`);return I(r,n),{seed:t,mode:r,sideKey:"restricted"===r?(null!=n?n:"").padEnd(81,"9"):void 0,security:e,start:0,count:1,nextCount:1,index:0}},t.createMessage=function(t,r){var n;if(!i.isTrytes(r))throw new Error("The message must be in trytes");const s=new f(t.seed,t.start,t.count,t.security),o=new f(t.seed,t.start+t.count,t.nextCount,t.security).root.addressTrits,l=i.toTrits(r),a=T(t.index),u=T(l.length),c=s.getSubtree(t.index),h=new e.Curl(27),d=i.toTrits(null!==(n=t.sideKey)&&void 0!==n?n:"9".repeat(81));h.absorb(d,0,d.length),h.absorb(s.root.addressTrits,0,s.root.addressTrits.length);let g=C([a,u]);h.absorb(g,0,g.length);const H=_(C([o,l]),h);g=C([g,H]);const A=(new E).search(h.rate(e.Curl.STATE_LENGTH),t.security,e.Curl.HASH_LENGTH/3,0);_(A,h),g=C([g,A]);const w=function(t,r){const n=new Int8Array(r.length),s=new e.Curl(27);for(let o=0;o<r.length/e.Curl.HASH_LENGTH;o++){let i=r.subarray(o*e.Curl.HASH_LENGTH,(o+1)*e.Curl.HASH_LENGTH);for(let e=0;e<13-(t[3*o]+3*t[3*o+1]+9*t[3*o+2]);e++)s.reset(),s.absorb(i,0,i.length),i=s.rate();n.set(i,o*e.Curl.HASH_LENGTH)}return n}(h.rate(),c.key),y=C(c.leaves.map((t=>t.addressTrits))),b=_(C([w,T(y.length/e.Curl.HASH_LENGTH),y]),h);g=C([g,b]);const I=g.length%3;0!==I&&(g=C([g,new Int8Array(3-I).fill(0)]));const L="public"===t.mode?s.root.addressTrits:S(s.root.addressTrits),F={payload:i.fromTrits(g),root:i.fromTrits(s.root.addressTrits),address:i.fromTrits(L)};return t.index===t.count-1?(t.start=t.nextCount+t.start,t.index=0):t.index++,t.nextRoot=i.fromTrits(o),F},t.decodeAddress=N,t.decodeMessages=G,t.mamAttach=async function(t,r,n){if(void 0!==n&&"string"!=typeof n)throw new Error("MWM and depth are no longer needed when calling mamAttach");if((n?n.length:0)>27)throw new Error("The tag length is too long");const s=n?i.packTrytes(n):void 0,o=s?s.length:0,l=i.packTrytes(r.payload),a=new Uint8Array(1+o+l.length);a[0]=o,s&&a.set(s,1),a.set(l,1+o);const u=e.Blake2b.sum256(e.Converter.utf8ToBytes(r.address)),c={payload:{type:e.INDEXATION_PAYLOAD_TYPE,index:e.Converter.bytesToHex(u),data:e.Converter.bytesToHex(a)}},h="string"==typeof t?new e.SingleNodeClient(t):t;return{message:c,messageId:await h.messageSubmit(c)}},t.mamFetch=p,t.mamFetchAll=async function(t,r,n,s,o){const i="string"==typeof t?new e.SingleNodeClient(t):t;I(n,s);const l=void 0===o?Number.MAX_VALUE:o,a=[];let u=r;do{const t=await p(i,u,n,s);t?(a.push(t),u=t.nextRoot):u=void 0}while(u&&a.length<l);return a},t.parseMessage=m,Object.defineProperty(t,"__esModule",{value:!0})}));