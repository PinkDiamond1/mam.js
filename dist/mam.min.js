!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@iota/converter"),require("@iota/validators"),require("big-integer")):"function"==typeof define&&define.amd?define(["exports","@iota/converter","@iota/validators","big-integer"],r):r((e=e||self).mam={},e.converter,e.validators,e.bigInt)}(this,(function(e,r,t,n){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n;var i=function(){function e(r){if(void 0===r&&(r=e.NUMBER_OF_ROUNDS),27!==r&&81!==r)throw new Error("Illegal number of rounds. Only `27` and `81` rounds are supported.");this._state=new Int8Array(e.STATE_LENGTH),this._rounds=r}return e.prototype.reset=function(){this._state=new Int8Array(e.STATE_LENGTH)},e.prototype.rate=function(r){return void 0===r&&(r=e.HASH_LENGTH),this._state.slice(0,r)},e.prototype.absorb=function(r,t,n){do{var i=n<e.HASH_LENGTH?n:e.HASH_LENGTH;this._state.set(r.subarray(t,t+i)),this.transform(),n-=e.HASH_LENGTH,t+=i}while(n>0)},e.prototype.squeeze=function(r,t,n){do{var i=n<e.HASH_LENGTH?n:e.HASH_LENGTH;r.set(this._state.subarray(0,i),t),this.transform(),n-=e.HASH_LENGTH,t+=i}while(n>0)},e.prototype.transform=function(){for(var r,t=0,n=0;n<this._rounds;n++){r=this._state.slice();for(var i=0;i<e.STATE_LENGTH;i++)this._state[i]=e.TRUTH_TABLE[r[t]+(r[t+=t<365?364:-365]<<2)+5]}},e.HASH_LENGTH=243,e.STATE_LENGTH=3*e.HASH_LENGTH,e.NUMBER_OF_ROUNDS=81,e.TRUTH_TABLE=[1,0,-1,2,1,-1,0,2,-1,1,0],e}(),a=27*i.HASH_LENGTH,o=-13,s=13,u=-1,l=1;function h(e){var r=new i(27);r.absorb(e,0,e.length);var t=new Int8Array(i.HASH_LENGTH);return r.squeeze(t,0,t.length),t}function c(e,r){var t=r*a,n=new Int8Array(t),o=new Int8Array(t),s=new i(27);s.absorb(e,0,e.length),s.squeeze(n,0,n.length);for(var u=0;u<t/i.HASH_LENGTH;u++){var l=u*i.HASH_LENGTH;s.reset(),s.absorb(n,l,i.HASH_LENGTH),o.set(s.rate(),l)}return o}function f(e,r,t){var n=function(e,r){for(var t=new i(27),n=e.slice(),a=r;a-- >0;)for(var o=0;o<n.length&&n[o]++>=l;o++)n[o]=u;t.absorb(n,0,n.length);var s=new Int8Array(i.HASH_LENGTH);return t.squeeze(s,0,s.length),s}(e,r);return{address:h(function(e,r){var t=new i(27),n=new i(27),u=new i(27),l=r*a/i.HASH_LENGTH,h=new Int8Array(i.HASH_LENGTH);t.absorb(e,0,e.length);for(var c=0;c<l;c++){t.squeeze(h,0,h.length);for(var f=0;f<s-o+1;f++)n.reset(),n.absorb(h,0,h.length),n.squeeze(h,0,h.length);u.absorb(h,0,h.length)}return u.squeeze(h,0,h.length),h}(n,t)),privateKey:c(n,t)}}var H=function(e,r,t,n){this.left=e,this.right=r,this.size=(e?e.size:0)+(r?r.size:0),this.addressTrits=t,this.privateKeyTrits=n},d=function(){function e(e,t,n,i){for(var a=r.trits(e),o=[],s=0;s<n;s++){var u=f(a,t+s,i);o.push(new H(void 0,void 0,u.address,u.privateKey)),o[s].size=1}this.root=this.buildTree(o)}return e.root=function(e,r,t){for(var n=new i(27),a=1,o=Math.ceil(r.length/i.HASH_LENGTH),s=0;s<o;s++){var u=r.slice(s*i.HASH_LENGTH,(s+1)*i.HASH_LENGTH);n.reset(),0==(a&t)?(n.absorb(e,0,e.length),n.absorb(u,0,u.length)):(n.absorb(u,0,u.length),n.absorb(e,0,e.length)),a<<=1,e=n.rate()}return n.rate()},e.prototype.getSubtree=function(e){if(1===this.root.size)return{key:this.root.left&&this.root.left.privateKeyTrits?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};var r,t=[],n=this.root,i=this.root.size;if(e<i)for(;n;){if(!n.left){r=n.privateKeyTrits;break}e<(i=n.left.size)?(t.push(n.right?n.right:n.left),n=n.left):(t.push(n.left),n=n.right,e-=i)}return t.reverse(),{key:r||new Int8Array,leaves:t}},e.prototype.buildTree=function(e){for(var r=[],t=0;t<e.length;t+=2){var n=e[t],a=t+1<e.length?e[t+1]:void 0,o=void 0;if(a){var s=new i(27);s.absorb(n.addressTrits,0,n.addressTrits.length),s.absorb(a.addressTrits,0,a.addressTrits.length),o=new Int8Array(i.HASH_LENGTH),s.squeeze(o,0,o.length)}else o=n.addressTrits;r.push(new H(n,a,o,void 0))}return 1===r.length?r[0]:this.buildTree(r)},e}(),v=new Int8Array([1,0,0,-1]),g=3,T=3;function b(e){if(0===e)return v;var t=y(E(Math.abs(e),1)),n=new Int8Array(function(e){var r=y(E(Math.abs(e),1));return r+r/g}(e));A(e,n);for(var i=0,a=0,o=0;o<t-T;o+=T){var s=n.slice(o,o+T);if(r.value(s)>=0){i|=1<<a;for(var u=0;u<s.length;u++)n[o+u]=-s[u]}a++}var l=n.slice(t-T,t-T+t);if(r.value(l)<0){i|=1<<a;for(var h=0;h<l.length;h++)n[h+t-T]=-n[h+t-T]}var c=new Int8Array(n.length-t);A(i,c);for(o=0;o<c.length;o++)n[t+o]=c[o];return n}function w(e){if(e.length>=v.length&&e[0]===v[0]&&e[1]===v[1]&&e[2]===v[2]&&e[3]===v[3])return{value:0,end:4};for(var t=function e(t){if(r.value(t.slice(0,T))>0)return T;return T+e(t.slice(T))}(e),n=t+t/T,i=r.value(e.slice(t,n)),a=0,o=0;o<t/T;o++){var s=0!=(i>>o&1)?-r.value(e.slice(o*T,(o+1)*T)):r.value(e.slice(o*T,(o+1)*T));a+=Math.pow(27,o)*s}return{value:a,end:n}}function y(e){var r=e%g;return 0===r?e:e+g-r}function E(e,r){return e<=r?1:1+E(e,1+r*g)}function A(e,r){var t=function e(r,t,n){switch(r){case 0:return 0;default:var i=Math.floor(r/g),a=r%g;return a>1&&(i+=1,a=-1),t[n]=a,n++,1+e(i,t,n)}}(e,r,0);if(e>=0)return t;for(var n=0;n<r.length;n++)r[n]=-r[n];return t}var _=function(){function e(){}return e.prototype.search=function(e,r,t,n){for(var a=this.prepareTrits(e,n),o=Math.min(t,i.HASH_LENGTH)-n,s=0;0===s;){var u=this.increment(a,n+2*o/3,n+o);o=Math.min(y(n+2*o/3+u),i.HASH_LENGTH)-n;var l={low:a.low.slice(),high:a.high.slice()};this.transform(l),s=this.check(r,l.low,l.high)}return this.trinaryGet(a.low,a.high,o,s)},e.prototype.prepareTrits=function(r,t){var n=this.tritsToBigInt(r,i.STATE_LENGTH);return n.low[t]=e.LOW_0,n.low[t+1]=e.LOW_1,n.low[t+2]=e.LOW_2,n.low[t+3]=e.LOW_3,n.high[t]=e.HIGH_0,n.high[t+1]=e.HIGH_1,n.high[t+2]=e.HIGH_2,n.high[t+3]=e.HIGH_3,n},e.prototype.tritsToBigInt=function(r,t){for(var n={low:[],high:[]},i=0;i<r.length;i++)switch(r[i]){case 0:n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;break;case 1:n.low[i]=e.MIN_VALUE,n.high[i]=e.MAX_VALUE;break;default:n.low[i]=e.MAX_VALUE,n.high[i]=e.MIN_VALUE}if(r.length>=t)return n;for(i=r.length;i<t;i++)n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;return n},e.prototype.increment=function(e,r,t){for(var n=r;n<t;n++){var i=e.low[n],a=e.high[n];if(e.low[n]=a.xor(i),e.high[n]=i,a.and(i.not()).equals(0))return t-r}return t-r+1},e.prototype.transform=function(r){for(var t=0,n=0;n<e.ROUNDS;n++)for(var a={low:r.low.slice(0,i.STATE_LENGTH),high:r.high.slice(0,i.STATE_LENGTH)},o=0;o<i.STATE_LENGTH;o++){var s=a.low[t],u=a.high[t];t+=t<365?364:-365;var l=a.high[t],h=a.low[t].xor(u),c=this.bitWiseNot(l),f=s.or(c).and(h);r.low[o]=this.bitWiseNot(f);var H=s.xor(l);r.high[o]=H.or(f)}},e.prototype.bitWiseNot=function(e){return n(1).shiftLeft(64).subtract(n(1)).subtract(e)},e.prototype.check=function(e,r,t){for(var i=0;i<64;i++){for(var a=0,o=0;o<e;o++){for(var s=243*o/3;s<243*(o+1)/3;s++){var u=n(1).shiftLeft(i);r[s].and(u).equals(0)?a--:t[s].and(u).equals(0)&&a++}if(0===a&&o<e-1){a=1;break}}if(0===a)return i}return 0},e.prototype.trinaryGet=function(e,r,t,i){for(var a=new Int8Array(t),o=0;o<t;o++){var s=n(i),u=e[o].shiftRight(s).and(1),l=r[o].shiftRight(s).and(1);u.equals(1)&&l.equals(0)?a[o]=-1:u.equals(0)&&l.equals(1)?a[o]=1:a[o]=0}return a},e.MAX_VALUE=n("FFFFFFFFFFFFFFFF",16),e.MIN_VALUE=n("0000000000000000",16),e.HIGH_0=n("B6DB6DB6DB6DB6DB",16),e.HIGH_1=n("8FC7E3F1F8FC7E3F",16),e.HIGH_2=n("FFC01FFFF803FFFF",16),e.HIGH_3=n("003FFFFFFFFFFFFF",16),e.LOW_0=n("DB6DB6DB6DB6DB6D",16),e.LOW_1=n("F1F8FC7E3F1F8FC7",16),e.LOW_2=n("7FFFE00FFFFC01FF",16),e.LOW_3=n("FFC0000007FFFFFF",16),e.ROUNDS=27,e}();function p(e){for(var r=0,t=0,n=e;t<n.length;t++){r+=(u=n[t]).length}for(var i=new Int8Array(r),a=0,o=0,s=e;o<s.length;o++){var u=s[o];i.set(u,a),a+=u.length}return i}function L(e,r){if("public"!==e&&"private"!==e&&"restricted"!==e)throw new Error("The mode must be public, private or restricted, it is '"+e+"'");if("restricted"===e){if(!r)throw new Error("You must provide a sideKey for restricted mode");if(!t.isTrytes(r))throw new Error("The sideKey must be in trytes");if(r.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==e&&r)throw new Error("sideKey is only used in restricted mode")}function F(e){var r=new i(81);r.absorb(e,0,e.length);var t=new Int8Array(i.HASH_LENGTH);return r.squeeze(t,0,t.length),t}function S(e,r){for(var t=r.rate(),n=Math.ceil(e.length/i.HASH_LENGTH),a=0;a<n;a++){var o=e.slice(a*i.HASH_LENGTH,(a+1)*i.HASH_LENGTH);r.absorb(o,0,o.length);for(var s=r.rate(),u=0;u<o.length;u++)e[a*i.HASH_LENGTH+u]=G(o[u],t[u]),t[u]=s[u]}return e}function N(e,r){for(var t,n=new Int8Array(e),a=Math.ceil(n.length/i.HASH_LENGTH)*i.HASH_LENGTH,o=0;o<a;o++){var s=o%i.HASH_LENGTH;0===s&&(t=r.rate()),t&&(n[o]=G(n[o],-t[s])),s===i.HASH_LENGTH-1&&r.absorb(n,Math.floor(o/i.HASH_LENGTH)*i.HASH_LENGTH,i.HASH_LENGTH)}return n}function G(e,r){var t=e+r;switch(t){case 2:return-1;case-2:return 1;default:return t}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var m=function(){return(m=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e}).apply(this,arguments)};function I(e,r,t,n){return new(t||(t=Promise))((function(i,a){function o(e){try{u(n.next(e))}catch(e){a(e)}}function s(e){try{u(n.throw(e))}catch(e){a(e)}}function u(e){e.done?i(e.value):new t((function(r){r(e.value)})).then(o,s)}u((n=n.apply(e,r||[])).next())}))}function M(e,r){var t,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;o;)try{if(t=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=r.call(e,o)}catch(e){a=[6,e],n=0}finally{t=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function x(e,t,n){var s=r.trits(e),u=r.trits(t),l=r.trits(n||"9".repeat(81)),h=w(s),c=h.value,f=w(s.slice(h.end)),H=f.value,v=h.end+f.end,g=v+i.HASH_LENGTH,T=g+H,b=new i(27);b.absorb(l,0,l.length),b.absorb(u,0,u.length),b.absorb(s,0,v);var y,E=N(s.slice(v,v+i.HASH_LENGTH),b),A=N(s.slice(g,g+H),b),_=N(s.slice(T,T+i.HASH_LENGTH/3),b),p=b.rate(),L=0===(y=p).slice(0,i.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?1:0===y.slice(0,2*i.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?2:0===y.reduce((function(e,r){return e+r}),0)?3:0;if(0===L)throw new Error("Message Hash did not have a hamming weight of zero, security level is invalid");var F=N(s.slice(T+_.length),b);b.reset();var S=function(e,r){for(var t=new i(27),n=new Int8Array(r.length),a=0;a<r.length/i.HASH_LENGTH;a++){for(var s=r.slice(a*i.HASH_LENGTH,(a+1)*i.HASH_LENGTH),u=0;u<e[3*a]+3*e[3*a+1]+9*e[3*a+2]-o;u++)t.reset(),t.absorb(s,0,s.length),s=t.rate();n.set(s,a*i.HASH_LENGTH)}return t.reset(),t.absorb(n,0,n.length),t.rate()}(p,F.slice(0,L*a));b.absorb(S,0,S.length);var G=w(F.slice(L*a)),m=G.value,I=b.rate();if(0!==m){var M=L*a+G.end,x=F.slice(M,M+m*i.HASH_LENGTH);I=d.root(I,x,c)}if(r.trytes(I)!==t)throw new Error("Signature did not match expected root");return{nextRoot:r.trytes(E),message:r.trytes(A)}}function O(e,t,n,i){return I(this,void 0,Promise,(function(){var a,o,s,u,l,h,c;return M(this,(function(f){switch(f.label){case 0:return L(n,i),a="public"===n?t:r.trytes(F(r.trits(t))),[4,e.findTransactionObjects({addresses:[a]})];case 1:if(0===(o=f.sent()).length)return[2];for(s=o.filter((function(e){return 0===e.currentIndex})),u=o.filter((function(e){return 0!==e.currentIndex})),l=function(e){for(var r=s[e].signatureMessageFragment,n=s[e],o=0;o<s[e].lastIndex;o++){var l=u.find((function(e){return e.hash===n.trunkTransaction}));if(!l)break;if(r+=l.signatureMessageFragment,n=l,o===s[e].lastIndex-1)try{var h=x(r,t,i);return{value:m(m({},h),{tag:s[e].tag})}}catch(e){throw new Error("Failed while trying to read MAM channel from address "+a+".\n"+e.message)}}},h=0;h<s.length;h++)if("object"==typeof(c=l(h)))return[2,c.value];return[2]}}))}))}e.channelRoot=function(e){if(!e)throw new Error("channelState must be provided");if(e.start<0)throw new Error("channelState.start must be >= 0");if(e.count<=0)throw new Error("channelState.count must be > 0");if(e.security<1||e.security>3)throw new Error("channelState.security must be between 1 and 3, it is "+e.security);var t=new d(e.seed,e.start,e.count,e.security);return r.trytes(t.root.addressTrits)},e.createChannel=function(e,r,n,i){if(!t.isTrytesOfExactLength(e,81))throw new Error("The seed must be 81 trytes long");if(r<1||r>3)throw new Error("Security must be between 1 and 3, it is "+r);return L(n,i),{seed:e,mode:n,sideKey:"restricted"===n?(i||"").padEnd(81,"9"):void 0,security:r,start:0,count:1,nextCount:1,index:0}},e.createMessage=function(e,n){if(!t.isTrytes(n))throw new Error("The message must be in trytes");var a=new d(e.seed,e.start,e.count,e.security),o=new d(e.seed,e.start+e.count,e.nextCount,e.security).root.addressTrits,u=r.trits(n),l=b(e.index),h=b(u.length),c=a.getSubtree(e.index),f=new i(27),H=r.trits(e.sideKey||"9".repeat(81));f.absorb(H,0,H.length),f.absorb(a.root.addressTrits,0,a.root.addressTrits.length);var v=p([l,h]);f.absorb(v,0,v.length);var g=S(p([o,u]),f);v=p([v,g]);var T=(new _).search(f.rate(i.STATE_LENGTH),e.security,i.HASH_LENGTH/3,0);S(T,f),v=p([v,T]);var w=function(e,r){for(var t=new Int8Array(r.length),n=new i(27),a=0;a<r.length/i.HASH_LENGTH;a++){for(var o=r.subarray(a*i.HASH_LENGTH,(a+1)*i.HASH_LENGTH),u=0;u<s-(e[3*a]+3*e[3*a+1]+9*e[3*a+2]);u++)n.reset(),n.absorb(o,0,o.length),o=n.rate();t.set(o,a*i.HASH_LENGTH)}return t}(f.rate(),c.key),y=p(c.leaves.map((function(e){return e.addressTrits}))),E=S(p([w,b(y.length/i.HASH_LENGTH),y]),f),A=(v=p([v,E])).length%3;0!==A&&(v=p([v,new Int8Array(3-A).fill(0)]));var L="public"===e.mode?a.root.addressTrits:F(a.root.addressTrits),N={payload:r.trytes(v),root:r.trytes(a.root.addressTrits),address:r.trytes(L)};return e.index===e.count-1?(e.start=e.nextCount+e.start,e.index=0):e.index++,e.nextRoot=r.trytes(o),N},e.mamAttach=function(e,r,t,n,i){return I(this,void 0,Promise,(function(){var a,o;return M(this,(function(s){switch(s.label){case 0:return a=[{address:r.address,value:0,message:r.payload,tag:i}],[4,e.prepareTransfers("9".repeat(81),a)];case 1:return o=s.sent(),[2,e.sendTrytes(o,t,n)]}}))}))},e.mamFetch=O,e.mamFetchAll=function(e,r,t,n,i){return I(this,void 0,Promise,(function(){var a,o,s,u;return M(this,(function(l){switch(l.label){case 0:L(t,n),a=void 0===i?Number.MAX_VALUE:i,o=[],s=r,l.label=1;case 1:return[4,O(e,s,t,n)];case 2:(u=l.sent())?(o.push(u),s=u.nextRoot):s=void 0,l.label=3;case 3:if(s&&o.length<a)return[3,1];l.label=4;case 4:return[2,o]}}))}))},e.parseMessage=x,Object.defineProperty(e,"__esModule",{value:!0})}));
