!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@iota/converter"),require("@iota/validators"),require("big-integer")):"function"==typeof define&&define.amd?define(["exports","@iota/converter","@iota/validators","big-integer"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).mam={},e.converter,e.validators,e.bigInt)}(this,(function(e,t,r,n){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=a(n),o=function(){function e(t){if(void 0===t&&(t=e.NUMBER_OF_ROUNDS),27!==t&&81!==t)throw new Error("Illegal number of rounds. Only `27` and `81` rounds are supported.");this._state=new Int8Array(e.STATE_LENGTH),this._rounds=t}return e.prototype.reset=function(){this._state=new Int8Array(e.STATE_LENGTH)},e.prototype.rate=function(t){return void 0===t&&(t=e.HASH_LENGTH),this._state.slice(0,t)},e.prototype.absorb=function(t,r,n){do{var a=n<e.HASH_LENGTH?n:e.HASH_LENGTH;this._state.set(t.subarray(r,r+a)),this.transform(),n-=e.HASH_LENGTH,r+=a}while(n>0)},e.prototype.squeeze=function(t,r,n){do{var a=n<e.HASH_LENGTH?n:e.HASH_LENGTH;t.set(this._state.subarray(0,a),r),this.transform(),n-=e.HASH_LENGTH,r+=a}while(n>0)},e.prototype.transform=function(){for(var t,r=0,n=0;n<this._rounds;n++){t=this._state.slice();for(var a=0;a<e.STATE_LENGTH;a++)this._state[a]=e.TRUTH_TABLE[t[r]+(t[r+=r<365?364:-365]<<2)+5]}},e.HASH_LENGTH=243,e.STATE_LENGTH=3*e.HASH_LENGTH,e.NUMBER_OF_ROUNDS=81,e.TRUTH_TABLE=[1,0,-1,2,1,-1,0,2,-1,1,0],e}(),s=27*o.HASH_LENGTH;function u(e){var t=new o(27);t.absorb(e,0,e.length);var r=new Int8Array(o.HASH_LENGTH);return t.squeeze(r,0,r.length),r}function l(e,t){var r=t*s,n=new Int8Array(r),a=new Int8Array(r),i=new o(27);i.absorb(e,0,e.length),i.squeeze(n,0,n.length);for(var u=0;u<r/o.HASH_LENGTH;u++){var l=u*o.HASH_LENGTH;i.reset(),i.absorb(n,l,o.HASH_LENGTH),a.set(i.rate(),l)}return a}function c(e,t,r){var n=function(e,t){for(var r=new o(27),n=e.slice(),a=t;a-- >0;)for(var i=0;i<n.length&&n[i]++>=1;i++)n[i]=-1;r.absorb(n,0,n.length);var s=new Int8Array(o.HASH_LENGTH);return r.squeeze(s,0,s.length),s}(e,t);return{address:u(function(e,t){var r=new o(27),n=new o(27),a=new o(27),i=t*s/o.HASH_LENGTH,u=new Int8Array(o.HASH_LENGTH);r.absorb(e,0,e.length);for(var l=0;l<i;l++){r.squeeze(u,0,u.length);for(var c=0;c<27;c++)n.reset(),n.absorb(u,0,u.length),n.squeeze(u,0,u.length);a.absorb(u,0,u.length)}return a.squeeze(u,0,u.length),u}(n,r)),privateKey:l(n,r)}}var h=function(e,t,r,n){this.left=e,this.right=t,this.size=(e?e.size:0)+(t?t.size:0),this.addressTrits=r,this.privateKeyTrits=n},f=function(){function e(e,r,n,a){for(var i=t.trits(e),o=[],s=0;s<n;s++){var u=c(i,r+s,a);o.push(new h(void 0,void 0,u.address,u.privateKey)),o[s].size=1}this.root=this.buildTree(o)}return e.root=function(e,t,r){for(var n=new o(27),a=1,i=Math.ceil(t.length/o.HASH_LENGTH),s=0;s<i;s++){var u=t.slice(s*o.HASH_LENGTH,(s+1)*o.HASH_LENGTH);n.reset(),0==(a&r)?(n.absorb(e,0,e.length),n.absorb(u,0,u.length)):(n.absorb(u,0,u.length),n.absorb(e,0,e.length)),a<<=1,e=n.rate()}return n.rate()},e.prototype.getSubtree=function(e){var t;if(1===this.root.size)return{key:(null===(t=this.root.left)||void 0===t?void 0:t.privateKeyTrits)?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};var r,n=[],a=this.root,i=this.root.size;if(e<i)for(;a;){if(!a.left){r=a.privateKeyTrits;break}e<(i=a.left.size)?(n.push(a.right?a.right:a.left),a=a.left):(n.push(a.left),a=a.right,e-=i)}return n.reverse(),{key:null!=r?r:new Int8Array,leaves:n}},e.prototype.buildTree=function(e){for(var t=[],r=0;r<e.length;r+=2){var n=e[r],a=r+1<e.length?e[r+1]:void 0,i=void 0;if(a){var s=new o(27);s.absorb(n.addressTrits,0,n.addressTrits.length),s.absorb(a.addressTrits,0,a.addressTrits.length),i=new Int8Array(o.HASH_LENGTH),s.squeeze(i,0,i.length)}else i=n.addressTrits;t.push(new h(n,a,i,void 0))}return 1===t.length?t[0]:this.buildTree(t)},e}(),d=new Int8Array([1,0,0,-1]);function H(e){if(0===e)return d;var r=g(b(Math.abs(e),1)),n=new Int8Array(function(e){var t=g(b(Math.abs(e),1));return t+t/3}(e));w(e,n);for(var a=0,i=0,o=0;o<r-3;o+=3){var s=n.slice(o,o+3);if(t.value(s)>=0){a|=1<<i;for(var u=0;u<s.length;u++)n[o+u]=-s[u]}i++}var l=n.slice(r-3,r-3+r);if(t.value(l)<0){a|=1<<i;for(var c=0;c<l.length;c++)n[c+r-3]=-n[c+r-3]}var h=new Int8Array(n.length-r);w(a,h);for(o=0;o<h.length;o++)n[r+o]=h[o];return n}function v(e){if(e.length>=d.length&&e[0]===d[0]&&e[1]===d[1]&&e[2]===d[2]&&e[3]===d[3])return{value:0,end:4};for(var r=T(e),n=r+r/3,a=t.value(e.slice(r,n)),i=0,o=0;o<r/3;o++){var s=0!=(a>>o&1)?-t.value(e.slice(3*o,3*(o+1))):t.value(e.slice(3*o,3*(o+1)));i+=Math.pow(27,o)*s}return{value:i,end:n}}function g(e){var t=e%3;return 0===t?e:e+3-t}function b(e,t){return e<=t?1:1+b(e,1+3*t)}function T(e){return t.value(e.slice(0,3))>0?3:3+T(e.slice(3))}function w(e,t){var r=y(e,t,0);if(e>=0)return r;for(var n=0;n<t.length;n++)t[n]=-t[n];return r}function y(e,t,r){switch(e){case 0:return 0;default:var n=Math.floor(e/3),a=e%3;return a>1&&(n+=1,a=-1),t[r]=a,1+y(n,t,++r)}}var E=function(){function e(){}return e.prototype.search=function(e,t,r,n){for(var a=this.prepareTrits(e,n),i=Math.min(r,o.HASH_LENGTH)-n,s=0;0===s;){var u=this.increment(a,n+2*i/3,n+i);i=Math.min(g(n+2*i/3+u),o.HASH_LENGTH)-n;var l={low:a.low.slice(),high:a.high.slice()};this.transform(l),s=this.check(t,l.low,l.high)}return this.trinaryGet(a.low,a.high,i,s)},e.prototype.prepareTrits=function(t,r){var n=this.tritsToBigInt(t,o.STATE_LENGTH);return n.low[r]=e.LOW_0,n.low[r+1]=e.LOW_1,n.low[r+2]=e.LOW_2,n.low[r+3]=e.LOW_3,n.high[r]=e.HIGH_0,n.high[r+1]=e.HIGH_1,n.high[r+2]=e.HIGH_2,n.high[r+3]=e.HIGH_3,n},e.prototype.tritsToBigInt=function(t,r){for(var n={low:[],high:[]},a=0;a<t.length;a++)switch(t[a]){case 0:n.low[a]=e.MAX_VALUE,n.high[a]=e.MAX_VALUE;break;case 1:n.low[a]=e.MIN_VALUE,n.high[a]=e.MAX_VALUE;break;default:n.low[a]=e.MAX_VALUE,n.high[a]=e.MIN_VALUE}if(t.length>=r)return n;for(a=t.length;a<r;a++)n.low[a]=e.MAX_VALUE,n.high[a]=e.MAX_VALUE;return n},e.prototype.increment=function(e,t,r){for(var n=t;n<r;n++){var a=e.low[n],i=e.high[n];if(e.low[n]=i.xor(a),e.high[n]=a,i.and(a.not()).equals(0))return r-t}return r-t+1},e.prototype.transform=function(t){for(var r=0,n=0;n<e.ROUNDS;n++)for(var a={low:t.low.slice(0,o.STATE_LENGTH),high:t.high.slice(0,o.STATE_LENGTH)},i=0;i<o.STATE_LENGTH;i++){var s=a.low[r],u=a.high[r];r+=r<365?364:-365;var l=a.high[r],c=a.low[r].xor(u),h=this.bitWiseNot(l),f=s.or(h).and(c);t.low[i]=this.bitWiseNot(f);var d=s.xor(l);t.high[i]=d.or(f)}},e.prototype.bitWiseNot=function(e){return i.default(1).shiftLeft(64).subtract(i.default(1)).subtract(e)},e.prototype.check=function(e,t,r){for(var n=0;n<64;n++){for(var a=0,o=0;o<e;o++){for(var s=243*o/3;s<243*(o+1)/3;s++){var u=i.default(1).shiftLeft(n);t[s].and(u).equals(0)?a--:r[s].and(u).equals(0)&&a++}if(0===a&&o<e-1){a=1;break}}if(0===a)return n}return 0},e.prototype.trinaryGet=function(e,t,r,n){for(var a=new Int8Array(r),o=0;o<r;o++){var s=i.default(n),u=e[o].shiftRight(s).and(1),l=t[o].shiftRight(s).and(1);u.equals(1)&&l.equals(0)?a[o]=-1:u.equals(0)&&l.equals(1)?a[o]=1:a[o]=0}return a},e.MAX_VALUE=i.default("FFFFFFFFFFFFFFFF",16),e.MIN_VALUE=i.default("0000000000000000",16),e.HIGH_0=i.default("B6DB6DB6DB6DB6DB",16),e.HIGH_1=i.default("8FC7E3F1F8FC7E3F",16),e.HIGH_2=i.default("FFC01FFFF803FFFF",16),e.HIGH_3=i.default("003FFFFFFFFFFFFF",16),e.LOW_0=i.default("DB6DB6DB6DB6DB6D",16),e.LOW_1=i.default("F1F8FC7E3F1F8FC7",16),e.LOW_2=i.default("7FFFE00FFFFC01FF",16),e.LOW_3=i.default("FFC0000007FFFFFF",16),e.ROUNDS=27,e}();function A(e){for(var t=0,r=0,n=e;r<n.length;r++){t+=(u=n[r]).length}for(var a=new Int8Array(t),i=0,o=0,s=e;o<s.length;o++){var u=s[o];a.set(u,i),i+=u.length}return a}function p(e,t){if("public"!==e&&"private"!==e&&"restricted"!==e)throw new Error("The mode must be public, private or restricted, it is '"+e+"'");if("restricted"===e){if(!t)throw new Error("You must provide a sideKey for restricted mode");if(!r.isTrytes(t))throw new Error("The sideKey must be in trytes");if(t.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==e&&t)throw new Error("sideKey is only used in restricted mode")}function _(e){var t=new o(81);t.absorb(e,0,e.length);var r=new Int8Array(o.HASH_LENGTH);return t.squeeze(r,0,r.length),r}function L(e,t){for(var r=t.rate(),n=Math.ceil(e.length/o.HASH_LENGTH),a=0;a<n;a++){var i=e.slice(a*o.HASH_LENGTH,(a+1)*o.HASH_LENGTH);t.absorb(i,0,i.length);for(var s=t.rate(),u=0;u<i.length;u++)e[a*o.HASH_LENGTH+u]=S(i[u],r[u]),r[u]=s[u]}return e}function F(e,t){for(var r,n=new Int8Array(e),a=Math.ceil(n.length/o.HASH_LENGTH)*o.HASH_LENGTH,i=0;i<a;i++){var s=i%o.HASH_LENGTH;0===s&&(r=t.rate()),r&&(n[i]=S(n[i],-r[s])),s===o.HASH_LENGTH-1&&t.absorb(n,Math.floor(i/o.HASH_LENGTH)*o.HASH_LENGTH,o.HASH_LENGTH)}return n}function S(e,t){var r=e+t;switch(r){case 2:return-1;case-2:return 1;default:return r}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var N=function(){return(N=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function G(e,t,r,n){return new(r||(r=Promise))((function(a,i){function o(e){try{u(n.next(e))}catch(e){i(e)}}function s(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}u((n=n.apply(e,t||[])).next())}))}function m(e,t){var r,n,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function I(e,r,n){var a=t.trits(e),i=t.trits(r),u=t.trits(null!=n?n:"9".repeat(81)),l=v(a),c=l.value,h=v(a.slice(l.end)),d=h.value,H=l.end+h.end,g=H+o.HASH_LENGTH,b=g+d,T=new o(27);T.absorb(u,0,u.length),T.absorb(i,0,i.length),T.absorb(a,0,H);var w,y=F(a.slice(H,H+o.HASH_LENGTH),T),E=F(a.slice(g,g+d),T),A=F(a.slice(b,b+o.HASH_LENGTH/3),T),p=T.rate(),_=0===(w=p).slice(0,o.HASH_LENGTH/3).reduce((function(e,t){return e+t}),0)?1:0===w.slice(0,2*o.HASH_LENGTH/3).reduce((function(e,t){return e+t}),0)?2:0===w.reduce((function(e,t){return e+t}),0)?3:0;if(0===_)throw new Error("Message Hash did not have a hamming weight of zero, security level is invalid");var L=F(a.slice(b+A.length),T);T.reset();var S=function(e,t){for(var r=new o(27),n=new Int8Array(t.length),a=0;a<t.length/o.HASH_LENGTH;a++){for(var i=t.slice(a*o.HASH_LENGTH,(a+1)*o.HASH_LENGTH),s=0;s<e[3*a]+3*e[3*a+1]+9*e[3*a+2]- -13;s++)r.reset(),r.absorb(i,0,i.length),i=r.rate();n.set(i,a*o.HASH_LENGTH)}return r.reset(),r.absorb(n,0,n.length),r.rate()}(p,L.slice(0,_*s));T.absorb(S,0,S.length);var N=v(L.slice(_*s)),G=N.value,m=T.rate();if(0!==G){var I=_*s+N.end,M=L.slice(I,I+G*o.HASH_LENGTH);m=f.root(m,M,c)}if(t.trytes(m)!==r)throw new Error("Signature did not match expected root");return{nextRoot:t.trytes(y),message:t.trytes(E)}}function M(e,t,r,n){return G(this,void 0,Promise,(function(){var a;return m(this,(function(i){switch(i.label){case 0:return p(r,n),a=x(t,r),[4,e.findTransactionObjects({addresses:[a]})];case 1:return[2,O(i.sent(),a,t,n)]}}))}))}function x(e,r){return"public"===r?e:t.trytes(_(t.trits(e)))}function O(e,t,r,n){return G(this,void 0,Promise,(function(){var a,i,o,s,u;return m(this,(function(l){if(!e||0===e.length)return[2];for(a=e.filter((function(e){return 0===e.currentIndex})),i=e.filter((function(e){return 0!==e.currentIndex})),o=function(e){for(var o=a[e].signatureMessageFragment,s=a[e],u=0;u<a[e].lastIndex;u++){var l=i.find((function(e){return e.hash===s.trunkTransaction}));if(!l)break;if(o+=l.signatureMessageFragment,s=l,u===a[e].lastIndex-1)try{var c=I(o,r,n);return{value:N(N({root:r},c),{tag:a[e].tag})}}catch(e){throw new Error("Failed while trying to read MAM channel from address "+t+".\n"+e.message)}}},s=0;s<a.length;s++)if("object"==typeof(u=o(s)))return[2,u.value];return[2]}))}))}e.channelRoot=function(e){if(!e)throw new Error("channelState must be provided");if(e.start<0)throw new Error("channelState.start must be >= 0");if(e.count<=0)throw new Error("channelState.count must be > 0");if(e.security<1||e.security>3)throw new Error("channelState.security must be between 1 and 3, it is "+e.security);var r=new f(e.seed,e.start,e.count,e.security);return t.trytes(r.root.addressTrits)},e.createChannel=function(e,t,n,a){if(!r.isTrytesOfExactLength(e,81))throw new Error("The seed must be 81 trytes long");if(t<1||t>3)throw new Error("Security must be between 1 and 3, it is "+t);return p(n,a),{seed:e,mode:n,sideKey:"restricted"===n?(null!=a?a:"").padEnd(81,"9"):void 0,security:t,start:0,count:1,nextCount:1,index:0}},e.createMessage=function(e,n){var a;if(!r.isTrytes(n))throw new Error("The message must be in trytes");var i=new f(e.seed,e.start,e.count,e.security),s=new f(e.seed,e.start+e.count,e.nextCount,e.security).root.addressTrits,u=t.trits(n),l=H(e.index),c=H(u.length),h=i.getSubtree(e.index),d=new o(27),v=t.trits(null!==(a=e.sideKey)&&void 0!==a?a:"9".repeat(81));d.absorb(v,0,v.length),d.absorb(i.root.addressTrits,0,i.root.addressTrits.length);var g=A([l,c]);d.absorb(g,0,g.length);var b=L(A([s,u]),d);g=A([g,b]);var T=(new E).search(d.rate(o.STATE_LENGTH),e.security,o.HASH_LENGTH/3,0);L(T,d),g=A([g,T]);var w=function(e,t){for(var r=new Int8Array(t.length),n=new o(27),a=0;a<t.length/o.HASH_LENGTH;a++){for(var i=t.subarray(a*o.HASH_LENGTH,(a+1)*o.HASH_LENGTH),s=0;s<13-(e[3*a]+3*e[3*a+1]+9*e[3*a+2]);s++)n.reset(),n.absorb(i,0,i.length),i=n.rate();r.set(i,a*o.HASH_LENGTH)}return r}(d.rate(),h.key),y=A(h.leaves.map((function(e){return e.addressTrits}))),p=L(A([w,H(y.length/o.HASH_LENGTH),y]),d),F=(g=A([g,p])).length%3;0!==F&&(g=A([g,new Int8Array(3-F).fill(0)]));var S="public"===e.mode?i.root.addressTrits:_(i.root.addressTrits),N={payload:t.trytes(g),root:t.trytes(i.root.addressTrits),address:t.trytes(S)};return e.index===e.count-1?(e.start=e.nextCount+e.start,e.index=0):e.index++,e.nextRoot=t.trytes(s),N},e.decodeAddress=x,e.decodeTransactions=O,e.mamAttach=function(e,t,r,n,a){return G(this,void 0,Promise,(function(){var i,o;return m(this,(function(s){switch(s.label){case 0:return i=[{address:t.address,value:0,message:t.payload,tag:a}],[4,e.prepareTransfers("9".repeat(81),i)];case 1:return o=s.sent(),[2,e.sendTrytes(o,r,n)]}}))}))},e.mamFetch=M,e.mamFetchAll=function(e,t,r,n,a){return G(this,void 0,Promise,(function(){var i,o,s,u;return m(this,(function(l){switch(l.label){case 0:p(r,n),i=void 0===a?Number.MAX_VALUE:a,o=[],s=t,l.label=1;case 1:return[4,M(e,s,r,n)];case 2:(u=l.sent())?(o.push(u),s=u.nextRoot):s=void 0,l.label=3;case 3:if(s&&o.length<i)return[3,1];l.label=4;case 4:return[2,o]}}))}))},e.mamFetchCombined=function(e,r){return G(this,void 0,Promise,(function(){var n,a,i,o,s;return m(this,(function(u){switch(u.label){case 0:return n=r.map((function(e){return"public"===e.mode?e.root:t.trytes(_(t.trits(e.root)))})),[4,e.findTransactionObjects({addresses:n})];case 1:a=u.sent(),i=[],o=function(e){var t,o;return m(this,(function(s){switch(s.label){case 0:return o=(t=i).push,[4,O(a.filter((function(t){return t.address===n[e]})),n[e],r[e].root,r[e].sideKey)];case 1:return o.apply(t,[s.sent()]),[2]}}))},s=0,u.label=2;case 2:return s<n.length?[5,o(s)]:[3,5];case 3:u.sent(),u.label=4;case 4:return s++,[3,2];case 5:return[2,i]}}))}))},e.parseMessage=I,Object.defineProperty(e,"__esModule",{value:!0})}));