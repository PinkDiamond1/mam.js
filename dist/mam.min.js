!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@iota/converter"),require("@iota/curl"),require("@iota/validators"),require("big-integer")):"function"==typeof define&&define.amd?define(["exports","@iota/converter","@iota/curl","@iota/validators","big-integer"],r):r((e=e||self).mam={},e.converter,e.Curl,e.validators,e.bigInt)}(this,(function(e,r,t,n,i){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,i=i&&i.hasOwnProperty("default")?i.default:i;var a=3*t.HASH_LENGTH;function s(e,r){return void 0===r&&(r=t.HASH_LENGTH),e.state.slice(0,r)}function o(e){for(var r=0,t=0,n=e;t<n.length;t++){r+=(u=n[t]).length}for(var i=new Int8Array(r),a=0,s=0,o=e;s<o.length;s++){var u=o[s];i.set(u,a),a+=u.length}return i}var u=27*t.HASH_LENGTH,l=-13,h=13,c=-1,f=1;function d(e){var r=new t(27),n=t.HASH_LENGTH;r.absorb(e,0,e.length);var i=new Int8Array(n);return r.squeeze(i,0,i.length),i}function v(e,r){var n=r*u,i=new Int8Array(n),a=[],l=new t(27);l.absorb(e,0,e.length),l.squeeze(i,0,i.length);for(var h=0;h<n/t.HASH_LENGTH;h++){var c=h*t.HASH_LENGTH;l.reset(),l.absorb(i,c,t.HASH_LENGTH),a.push(s(l))}return o(a)}function H(e,r,n){var i=function(e,r){var n=new t(27);n.initialize();for(var i=e.slice(),a=r;a-- >0;)for(var s=0;s<i.length&&i[s]++>=f;s++)i[s]=c;n.absorb(i,0,i.length);var o=new Int8Array(t.HASH_LENGTH);return n.squeeze(o,0,o.length),o}(e,r);return{address:d(function(e,r){var n=new t(27),i=new t(27),a=new t(27),s=r*u/t.HASH_LENGTH,o=new Int8Array(t.HASH_LENGTH);n.absorb(e,0,e.length);for(var c=0;c<s;c++){n.squeeze(o,0,o.length);for(var f=0;f<h-l+1;f++)i.reset(),i.absorb(o,0,o.length),i.squeeze(o,0,o.length);a.absorb(o,0,o.length)}return a.squeeze(o,0,o.length),o}(i,n)),privateKey:v(i,n)}}var g=function(e,r,t,n){this.left=e,this.right=r,this.size=(e?e.size:0)+(r?r.size:0),this.addressTrits=t,this.privateKeyTrits=n},b=function(){function e(e,t,n,i){for(var a=r.trits(e),s=[],o=0;o<n;o++){var u=H(a,t+o,i);s.push(new g(void 0,void 0,u.address,u.privateKey)),s[o].size=1}this.root=this.buildTree(s)}return e.root=function(e,r,n){for(var i=new t(27),a=1,o=Math.ceil(r.length/t.HASH_LENGTH),u=0;u<o;u++){var l=r.slice(u*t.HASH_LENGTH,(u+1)*t.HASH_LENGTH);i.reset(),0==(a&n)?(i.absorb(e,0,e.length),i.absorb(l,0,l.length)):(i.absorb(l,0,l.length),i.absorb(e,0,e.length)),a<<=1,e=s(i)}return s(i)},e.prototype.getSubtree=function(e){if(1===this.root.size)return{key:this.root.left&&this.root.left.privateKeyTrits?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};var r,t=[],n=this.root,i=this.root.size;if(e<i)for(;n;){if(!n.left){r=n.privateKeyTrits;break}e<(i=n.left.size)?(t.push(n.right?n.right:n.left),n=n.left):(t.push(n.left),n=n.right,e-=i)}return t.reverse(),{key:r||new Int8Array,leaves:t}},e.prototype.buildTree=function(e){for(var r=[],n=0;n<e.length;n+=2){var i=e[n],a=n+1<e.length?e[n+1]:void 0,s=void 0;if(a){var o=new t(27);o.initialize(),o.absorb(i.addressTrits,0,i.addressTrits.length),o.absorb(a.addressTrits,0,a.addressTrits.length),s=new Int8Array(t.HASH_LENGTH),o.squeeze(s,0,s.length)}else s=i.addressTrits;r.push(new g(i,a,s,void 0))}return 1===r.length?r[0]:this.buildTree(r)},e}(),w=new Int8Array([1,0,0,-1]),y=3,p=3;function T(e){if(0===e)return w;var t=F(E(Math.abs(e),1)),n=new Int8Array(function(e){var r=F(E(Math.abs(e),1));return r+r/y}(e));_(e,n);for(var i=0,a=0,s=0;s<t-p;s+=p){var o=n.slice(s,s+p);if(r.value(o)>=0){i|=1<<a;for(var u=0;u<o.length;u++)n[s+u]=-o[u]}a++}var l=n.slice(t-p,t-p+t);if(r.value(l)<0){i|=1<<a;for(var h=0;h<l.length;h++)n[h+t-p]=-n[h+t-p]}var c=new Int8Array(n.length-t);_(i,c);for(s=0;s<c.length;s++)n[t+s]=c[s];return n}function A(e){if(e.length>=w.length&&e[0]===w[0]&&e[1]===w[1]&&e[2]===w[2]&&e[3]===w[3])return{value:0,end:4};for(var t=function e(t){if(r.value(t.slice(0,p))>0)return p;return p+e(t.slice(p))}(e),n=t+t/p,i=r.value(e.slice(t,n)),a=0,s=0;s<t/p;s++){var o=0!=(i>>s&1)?-r.value(e.slice(s*p,(s+1)*p)):r.value(e.slice(s*p,(s+1)*p));a+=Math.pow(27,s)*o}return{value:a,end:n}}function F(e){var r=e%y;return 0===r?e:e+y-r}function E(e,r){return e<=r?1:1+E(e,1+r*y)}function _(e,r){var t=function e(r,t,n){switch(r){case 0:return 0;default:var i=Math.floor(r/y),a=r%y;return a>1&&(i+=1,a=-1),t[n]=a,n++,1+e(i,t,n)}}(e,r,0);if(e>=0)return t;for(var n=0;n<r.length;n++)r[n]=-r[n];return t}var L=function(){function e(){}return e.prototype.search=function(e,r,n,i){for(var a=this.prepareTrits(e,i),s=Math.min(n,t.HASH_LENGTH)-i,o=0;0===o;){var u=this.increment(a,i+2*s/3,i+s);s=Math.min(F(i+2*s/3+u),t.HASH_LENGTH)-i;var l={low:a.low.slice(),high:a.high.slice()};this.transform(l),o=this.check(r,l.low,l.high)}return this.trinaryGet(a.low,a.high,s,o)},e.prototype.prepareTrits=function(r,t){var n=this.tritsToBigInt(r,a);return n.low[t]=e.LOW_0,n.low[t+1]=e.LOW_1,n.low[t+2]=e.LOW_2,n.low[t+3]=e.LOW_3,n.high[t]=e.HIGH_0,n.high[t+1]=e.HIGH_1,n.high[t+2]=e.HIGH_2,n.high[t+3]=e.HIGH_3,n},e.prototype.tritsToBigInt=function(r,t){for(var n={low:[],high:[]},i=0;i<r.length;i++)switch(r[i]){case 0:n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;break;case 1:n.low[i]=e.MIN_VALUE,n.high[i]=e.MAX_VALUE;break;default:n.low[i]=e.MAX_VALUE,n.high[i]=e.MIN_VALUE}if(r.length>=t)return n;for(i=r.length;i<t;i++)n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;return n},e.prototype.increment=function(e,r,t){for(var n=r;n<t;n++){var i=e.low[n],a=e.high[n];if(e.low[n]=a.xor(i),e.high[n]=i,a.and(i.not()).equals(0))return t-r}return t-r+1},e.prototype.transform=function(r){for(var t=0,n=0;n<e.ROUNDS;n++)for(var i={low:r.low.slice(0,a),high:r.high.slice(0,a)},s=0;s<a;s++){var o=i.low[t],u=i.high[t];t+=t<365?364:-365;var l=i.high[t],h=i.low[t].xor(u),c=this.bitWiseNot(l),f=o.or(c).and(h);r.low[s]=this.bitWiseNot(f);var d=o.xor(l);r.high[s]=d.or(f)}},e.prototype.bitWiseNot=function(e){return i(1).shiftLeft(64).subtract(i(1)).subtract(e)},e.prototype.check=function(e,r,t){for(var n=0;n<64;n++){for(var a=0,s=0;s<e;s++){for(var o=243*s/3;o<243*(s+1)/3;o++){var u=i(1).shiftLeft(n);r[o].and(u).equals(0)?a--:t[o].and(u).equals(0)&&a++}if(0===a&&s<e-1){a=1;break}}if(0===a)return n}return 0},e.prototype.trinaryGet=function(e,r,t,n){for(var a=new Int8Array(t),s=0;s<t;s++){var o=i(n),u=e[s].shiftRight(o).and(1),l=r[s].shiftRight(o).and(1);u.equals(1)&&l.equals(0)?a[s]=-1:u.equals(0)&&l.equals(1)?a[s]=1:a[s]=0}return a},e.MAX_VALUE=i("FFFFFFFFFFFFFFFF",16),e.MIN_VALUE=i("0000000000000000",16),e.HIGH_0=i("B6DB6DB6DB6DB6DB",16),e.HIGH_1=i("8FC7E3F1F8FC7E3F",16),e.HIGH_2=i("FFC01FFFF803FFFF",16),e.HIGH_3=i("003FFFFFFFFFFFFF",16),e.LOW_0=i("DB6DB6DB6DB6DB6D",16),e.LOW_1=i("F1F8FC7E3F1F8FC7",16),e.LOW_2=i("7FFFE00FFFFC01FF",16),e.LOW_3=i("FFC0000007FFFFFF",16),e.ROUNDS=27,e}();function m(e,r){if("public"!==e&&"private"!==e&&"restricted"!==e)throw new Error("The mode must be public, private or restricted, it is '"+e+"'");if("restricted"===e){if(!r)throw new Error("You must provide a sideKey for restricted mode");if(!n.isTrytes(r))throw new Error("The sideKey must be in trytes");if(r.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==e&&r)throw new Error("sideKey is only used in restricted mode")}function S(e){var r=new t(81);r.reset(),r.absorb(e,0,e.length);var n=new Int8Array(t.HASH_LENGTH);return r.squeeze(n,0,n.length),n}function G(e,r){for(var n=s(r),i=Math.ceil(e.length/t.HASH_LENGTH),a=0;a<i;a++){var o=e.slice(a*t.HASH_LENGTH,(a+1)*t.HASH_LENGTH);r.absorb(o,0,o.length);for(var u=s(r),l=0;l<o.length;l++)e[a*t.HASH_LENGTH+l]=I(o[l],n[l]),n[l]=u[l]}return e}function N(e,r){for(var n=[],i=Math.ceil(e.length/t.HASH_LENGTH),a=0;a<i;a++){for(var u=e.slice(a*t.HASH_LENGTH,(a+1)*t.HASH_LENGTH),l=s(r),h=0;h<u.length;h++)u[h]=I(u[h],-l[h]);n.push(u),r.absorb(u,0,u.length)}return o(n)}function I(e,r){var t=e+r;switch(t){case 2:return-1;case-2:return 1;default:return t}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var x=function(){return(x=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e}).apply(this,arguments)};function M(e,r,t,n){return new(t||(t=Promise))((function(i,a){function s(e){try{u(n.next(e))}catch(e){a(e)}}function o(e){try{u(n.throw(e))}catch(e){a(e)}}function u(e){e.done?i(e.value):new t((function(r){r(e.value)})).then(s,o)}u((n=n.apply(e,r||[])).next())}))}function q(e,r){var t,n,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=r.call(e,s)}catch(e){a=[6,e],n=0}finally{t=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function z(e,n,i){var a=r.trits(e),h=r.trits(n),c=r.trits(i||"9".repeat(81)),f=A(a),d=f.value,v=A(a.slice(f.end)),H=v.value,g=f.end+v.end,w=g+t.HASH_LENGTH,y=w+H,p=new t(27);p.absorb(c,0,c.length),p.absorb(h,0,h.length),p.absorb(a,0,g);var T,F=N(a.slice(g,g+t.HASH_LENGTH),p),E=N(a.slice(w,w+H),p),_=N(a.slice(y,y+t.HASH_LENGTH/3),p),L=s(p),m=0===(T=L).slice(0,t.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?1:0===T.slice(0,2*t.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?2:0===T.reduce((function(e,r){return e+r}),0)?3:0;if(0===m)throw new Error("Message Hash did not have a hamming weight of zero, security level is invalid");var S=N(a.slice(y+_.length),p);p.reset();var G=function(e,r){for(var n=new t(27),i=[],a=0;a<r.length/t.HASH_LENGTH;a++){for(var u=r.slice(a*t.HASH_LENGTH,(a+1)*t.HASH_LENGTH),h=0;h<e[3*a]+3*e[3*a+1]+9*e[3*a+2]-l;h++)n.reset(),n.absorb(u,0,u.length),u=s(n);i.push(u)}n.reset();var c=o(i);return n.absorb(c,0,c.length),s(n)}(L,S.slice(0,m*u));p.absorb(G,0,G.length);var I=A(S.slice(m*u)),x=I.value,M=s(p);if(0!==x){var q=m*u+I.end,z=S.slice(q,q+x*t.HASH_LENGTH);M=b.root(M,z,d)}if(r.trytes(M)!==n)throw new Error("Signature did not match expected root");return{nextRoot:r.trytes(F),message:r.trytes(E)}}function O(e,t,n,i){return M(this,void 0,Promise,(function(){var a,s,o,u,l,h,c;return q(this,(function(f){switch(f.label){case 0:return m(n,i),a="public"===n?t:r.trytes(S(r.trits(t))),[4,e.findTransactionObjects({addresses:[a]})];case 1:if(0===(s=f.sent()).length)return[2];for(o=s.filter((function(e){return 0===e.currentIndex})),u=s.filter((function(e){return 0!==e.currentIndex})),l=function(e){for(var r=o[e].signatureMessageFragment,n=o[e],s=0;s<o[e].lastIndex;s++){var l=u.find((function(e){return e.hash===n.trunkTransaction}));if(!l)break;if(r+=l.signatureMessageFragment,n=l,s===o[e].lastIndex-1)try{var h=z(r,t,i);return{value:x(x({},h),{tag:o[e].tag})}}catch(e){throw new Error("Failed while trying to read MAM channel from address "+a+".\n"+e.message)}}},h=0;h<o.length;h++)if("object"==typeof(c=l(h)))return[2,c.value];return[2]}}))}))}e.channelRoot=function(e){if(!e)throw new Error("channelState must be provided");if(e.start<0)throw new Error("channelState.start must be >= 0");if(e.count<=0)throw new Error("channelState.count must be > 0");if(e.security<1||e.security>3)throw new Error("channelState.security must be between 1 and 3, it is "+e.security);var t=new b(e.seed,e.start,e.count,e.security);return r.trytes(t.root.addressTrits)},e.createChannel=function(e,r,t,i){if(!n.isTrytesOfExactLength(e,81))throw new Error("The seed must be 81 trytes long");if(r<1||r>3)throw new Error("Security must be between 1 and 3, it is "+r);return m(t,i),{seed:e,mode:t,sideKey:"restricted"===t?(i||"").padEnd(81,"9"):void 0,security:r,start:0,count:1,nextCount:1,index:0}},e.createMessage=function(e,i){if(!n.isTrytes(i))throw new Error("The message must be in trytes");var u=new b(e.seed,e.start,e.count,e.security),l=new b(e.seed,e.start+e.count,e.nextCount,e.security).root.addressTrits,c=r.trits(i),f=T(e.index),d=T(c.length),v=u.getSubtree(e.index),H=new t(27),g=r.trits(e.sideKey||"9".repeat(81));H.absorb(g,0,g.length),H.absorb(u.root.addressTrits,0,u.root.addressTrits.length);var w=o([f,d]);H.absorb(w,0,w.length);var y=G(o([l,c]),H);w=o([w,y]);var p=(new L).search(s(H,a),e.security,t.HASH_LENGTH/3,0);G(p,H),w=o([w,p]);var A=function(e,r){for(var n=[],i=new t(27),a=0;a<r.length/t.HASH_LENGTH;a++){for(var u=r.slice(a*t.HASH_LENGTH,(a+1)*t.HASH_LENGTH),l=0;l<h-(e[3*a]+3*e[3*a+1]+9*e[3*a+2]);l++)i.reset(),i.absorb(u,0,u.length),u=s(i);n.push(u)}return o(n)}(s(H),v.key),F=o(v.leaves.map((function(e){return e.addressTrits}))),E=G(o([A,T(F.length/t.HASH_LENGTH),F]),H),_=(w=o([w,E])).length%3;0!==_&&(w=o([w,new Int8Array(3-_).fill(0)]));var m="public"===e.mode?u.root.addressTrits:S(u.root.addressTrits),N={payload:r.trytes(w),root:r.trytes(u.root.addressTrits),address:r.trytes(m)};return e.index===e.count-1?(e.start=e.nextCount+e.start,e.index=0):e.index++,e.nextRoot=r.trytes(l),N},e.mamAttach=function(e,r,t,n,i){return M(this,void 0,Promise,(function(){var a,s;return q(this,(function(o){switch(o.label){case 0:return a=[{address:r.address,value:0,message:r.payload,tag:i}],[4,e.prepareTransfers("9".repeat(81),a)];case 1:return s=o.sent(),[2,e.sendTrytes(s,t,n)]}}))}))},e.mamFetch=O,e.mamFetchAll=function(e,r,t,n,i){return M(this,void 0,Promise,(function(){var a,s,o,u;return q(this,(function(l){switch(l.label){case 0:m(t,n),a=void 0===i?Number.MAX_VALUE:i,s=[],o=r,l.label=1;case 1:return[4,O(e,o,t,n)];case 2:(u=l.sent())?(s.push(u),o=u.nextRoot):o=void 0,l.label=3;case 3:if(o&&s.length<a)return[3,1];l.label=4;case 4:return[2,s]}}))}))},e.parseMessage=z,Object.defineProperty(e,"__esModule",{value:!0})}));
