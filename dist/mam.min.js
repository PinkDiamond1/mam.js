!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@iota/converter"),require("@iota/curl"),require("@iota/validators"),require("big-integer")):"function"==typeof define&&define.amd?define(["exports","@iota/converter","@iota/curl","@iota/validators","big-integer"],r):r((e=e||self).mam={},e.converter,e.Curl,e.validators,e.bigInt)}(this,(function(e,r,t,n,i){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,i=i&&i.hasOwnProperty("default")?i.default:i;var o=3*t.HASH_LENGTH;function s(e,r){return void 0===r&&(r=t.HASH_LENGTH),e.state.slice(0,r)}function a(e){for(var r=0,t=0,n=e;t<n.length;t++){r+=(u=n[t]).length}for(var i=new Int8Array(r),o=0,s=0,a=e;s<a.length;s++){var u=a[s];i.set(u,o),o+=u.length}return i}var u=27*t.HASH_LENGTH,l=-13,h=13,c=-1,f=1;function v(e){var r=new t(27),n=t.HASH_LENGTH;r.initialize(),r.absorb(e,0,e.length);var i=new Int8Array(n);return r.squeeze(i,0,i.length),i}function d(e,r){var n=r*u,i=new Int8Array(n),o=[],l=new t(27);l.initialize(),l.reset(),l.absorb(e,0,e.length),l.squeeze(i,0,i.length);for(var h=0;h<n/t.HASH_LENGTH;h++){var c=h*t.HASH_LENGTH;l.reset(),l.absorb(i,c,t.HASH_LENGTH),o.push(s(l))}return a(o)}function H(e,r,n){var i=function(e,r){var n=new t(27);n.initialize();for(var i=e.slice(),o=r;o-- >0;)for(var s=0;s<i.length&&++i[s]>f;s++)i[s]=c;n.absorb(i,0,i.length);var a=new Int8Array(t.HASH_LENGTH);return n.squeeze(a,0,a.length),a}(e,r);return{address:v(function(e,r){var n=new t(27),i=new t(27),o=new t(27),s=r*u/t.HASH_LENGTH,a=new Int8Array(t.HASH_LENGTH);n.reset(),i.reset(),o.reset(),n.absorb(e,0,e.length);for(var c=0;c<s;c++){n.squeeze(a,0,a.length);for(var f=0;f<h-l+1;f++)i.reset(),i.absorb(a,0,a.length),i.squeeze(a,0,a.length);o.absorb(a,0,a.length)}return o.squeeze(a,0,a.length),a}(i,n)),privateKey:d(i,n)}}var g=function(e,r,t,n){this.left=e,this.right=r,this.size=(e?e.size:0)+(r?r.size:0),this.addressTrits=t,this.privateKeyTrits=n},b=function(){function e(e,t,n,i){for(var o=r.trits(e),s=[],a=0;a<n;a++){var u=H(o,t+a,i);s.push(new g(void 0,void 0,u.address,u.privateKey)),s[a].size=1}this.root=this.buildTree(s)}return e.root=function(e,r,n){for(var i=new t(27),o=1,a=Math.ceil(r.length/t.HASH_LENGTH),u=0;u<a;u++){var l=r.slice(u*t.HASH_LENGTH,(u+1)*t.HASH_LENGTH);i.reset(),0==(o&n)?(i.absorb(e,0,e.length),i.absorb(l,0,l.length)):(i.absorb(l,0,l.length),i.absorb(e,0,e.length)),o<<=1,e=s(i)}return s(i)},e.prototype.getSubtree=function(e){if(1===this.root.size)return{key:this.root.left&&this.root.left.privateKeyTrits?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};var r,t=[],n=this.root,i=this.root.size;if(e<i)for(;n;){if(!n.left){r=n.privateKeyTrits;break}e<(i=n.left.size)?(t.push(n.right?n.right:n.left),n=n.left):(t.push(n.left),n=n.right,e-=i)}return t.reverse(),{key:r||new Int8Array,leaves:t}},e.prototype.buildTree=function(e){for(var r=[],n=0;n<e.length;n+=2){var i=e[n],o=n+1<e.length?e[n+1]:void 0,s=void 0;if(o){var a=new t(27);a.initialize(),a.absorb(i.addressTrits,0,i.addressTrits.length),a.absorb(o.addressTrits,0,o.addressTrits.length),s=new Int8Array(t.HASH_LENGTH),a.squeeze(s,0,s.length)}else s=i.addressTrits;r.push(new g(i,o,s,void 0))}return 1===r.length?r[0]:this.buildTree(r)},e}(),w=new Int8Array([1,0,0,-1]),y=3,p=3;function T(e){if(0===e)return w;var t=F(_(Math.abs(e),1)),n=new Int8Array(function(e){var r=F(_(Math.abs(e),1));return r+r/y}(e));E(e,n);for(var i=0,o=0,s=0;s<t-p;s+=p){var a=n.slice(s,s+p);if(r.value(a)>=0){i|=1<<o;for(var u=0;u<a.length;u++)n[s+u]=-a[u]}o++}var l=n.slice(t-p,t-p+t);if(r.value(l)<0){i|=1<<o;for(var h=0;h<l.length;h++)n[h+t-p]=-n[h+t-p]}var c=new Int8Array(n.length-t);E(i,c);for(s=0;s<c.length;s++)n[t+s]=c[s];return n}function A(e){if(e.length>=w.length&&e[0]===w[0]&&e[1]===w[1]&&e[2]===w[2]&&e[3]===w[3])return{value:0,end:4};for(var t=function e(t){if(r.value(t.slice(0,p))>0)return p;return p+e(t.slice(p))}(e),n=t+t/p,i=r.value(e.slice(t,n)),o=0,s=0;s<t/p;s++){var a=0!=(i>>s&1)?-r.value(e.slice(s*p,(s+1)*p)):r.value(e.slice(s*p,(s+1)*p));o+=Math.pow(27,s)*a}return{value:o,end:n}}function F(e){var r=e%y;return 0===r?e:e+y-r}function _(e,r){return e<=r?1:1+_(e,1+r*y)}function E(e,r){var t=function e(r,t,n){switch(r){case 0:return 0;default:var i=Math.floor(r/y),o=r%y;return o>1&&(i+=1,o=-1),t[n]=o,n++,1+e(i,t,n)}}(e,r,0);if(e>=0)return t;for(var n=0;n<r.length;n++)r[n]=-r[n];return t}var L=function(){function e(){}return e.prototype.search=function(e,r,n,i){for(var o=this.prepareTrits(e,i),s={low:o.low,high:o.high},a=Math.min(n,t.HASH_LENGTH)-i,u=0;0===u;){var l=this.increment(s,i+2*a/3,i+a);a=Math.min(F(i+2*a/3+l),t.HASH_LENGTH)-i;var h={low:s.low.slice(),high:s.high.slice()};this.transform(h),u=this.check(r,h.low.slice(0,t.HASH_LENGTH),h.high.slice(0,t.HASH_LENGTH))}return this.trinaryGet(s.low.slice(0,a),s.high.slice(0,a),u)},e.prototype.prepareTrits=function(r,t){var n=this.tritsToBigInt(r,o);return n.low[t]=e.LOW_0,n.low[t+1]=e.LOW_1,n.low[t+2]=e.LOW_2,n.low[t+3]=e.LOW_3,n.high[t]=e.HIGH_0,n.high[t+1]=e.HIGH_1,n.high[t+2]=e.HIGH_2,n.high[t+3]=e.HIGH_3,n},e.prototype.tritsToBigInt=function(r,t){for(var n={low:[],high:[]},i=0;i<r.length;i++)switch(r[i]){case 0:n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;break;case 1:n.low[i]=e.MIN_VALUE,n.high[i]=e.MAX_VALUE;break;default:n.low[i]=e.MAX_VALUE,n.high[i]=e.MIN_VALUE}if(r.length>=t)return n;for(i=r.length;i<t;i++)n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;return n},e.prototype.increment=function(e,r,t){for(var n=r;n<t;n++){var i=e.low[n],o=e.high[n];if(e.low[n]=o.xor(i),e.high[n]=i,0===o.and(i.not()).toJSNumber())return t-r}return t-r+1},e.prototype.transform=function(r){for(var t=0,n=0;n<e.ROUNDS;n++)for(var i={low:r.low.slice(0,o),high:r.high.slice(0,o)},s=0;s<o;s++){var a=i.low[t],u=i.high[t];t+=t<365?364:-365;var l=i.high[t],h=i.low[t].xor(u),c=this.bitWiseNot(l),f=a.or(c).and(h);r.low[s]=this.bitWiseNot(f);var v=a.xor(l);r.high[s]=v.or(f)}},e.prototype.bitWiseNot=function(e){return i(1).shiftLeft(64).subtract(i(1)).subtract(e)},e.prototype.check=function(e,r,n){for(var i=this.trinaryLength(r,n),o=0;o<i;o++){for(var s=0,a=0;a<e;a++){if(0===(s+=this.trinaryGet(r,n,o).slice(a*t.HASH_LENGTH/3,(a+1)*t.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0))&&a<e-1){s=1;break}}if(0===s)return o}return 0},e.prototype.trinaryLength=function(e,r){var t=e[0].toString(2).padStart(64,"0"),n=r[0].toString(2).padStart(64,"0");return 64-Math.min(t.split("1")[0].length,n.split("1")[0].length)},e.prototype.trinaryGet=function(e,r,t){for(var n=new Int8Array(e.length),o=0;o<e.length;o++){var s=e[o].shiftRight(i(t)).and(1).toJSNumber(),a=r[o].shiftRight(i(t)).and(1).toJSNumber();n[o]=1===s&&0===a?-1:0===s&&1===a?1:0}return n},e.MAX_VALUE=i("FFFFFFFFFFFFFFFF",16),e.MIN_VALUE=i("0000000000000000",16),e.HIGH_0=i("B6DB6DB6DB6DB6DB",16),e.HIGH_1=i("8FC7E3F1F8FC7E3F",16),e.HIGH_2=i("FFC01FFFF803FFFF",16),e.HIGH_3=i("003FFFFFFFFFFFFF",16),e.LOW_0=i("DB6DB6DB6DB6DB6D",16),e.LOW_1=i("F1F8FC7E3F1F8FC7",16),e.LOW_2=i("7FFFE00FFFFC01FF",16),e.LOW_3=i("FFC0000007FFFFFF",16),e.ROUNDS=27,e}();function S(e){var r=new t(81);r.reset(),r.absorb(e,0,e.length);var n=new Int8Array(t.HASH_LENGTH);return r.squeeze(n,0,n.length),n}function G(e,r){for(var n=s(r),i=Math.ceil(e.length/t.HASH_LENGTH),o=0;o<i;o++){var a=e.slice(o*t.HASH_LENGTH,(o+1)*t.HASH_LENGTH);r.absorb(a,0,a.length);for(var u=s(r),l=0;l<a.length;l++)e[o*t.HASH_LENGTH+l]=m(a[l],n[l]),n[l]=u[l]}return e}function N(e,r){for(var n=[],i=Math.ceil(e.length/t.HASH_LENGTH),o=0;o<i;o++){for(var u=e.slice(o*t.HASH_LENGTH,(o+1)*t.HASH_LENGTH),l=s(r),h=0;h<u.length;h++)u[h]=m(u[h],-l[h]);n.push(u),r.absorb(u,0,u.length)}return a(n)}function m(e,r){var t=e+r;switch(t){case 2:return-1;case-2:return 1;default:return t}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var I=function(){return(I=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e}).apply(this,arguments)};function x(e,r,t,n){return new(t||(t=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new t((function(r){r(e.value)})).then(s,a)}u((n=n.apply(e,r||[])).next())}))}function M(e,r){var t,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=r.call(e,s)}catch(e){o=[6,e],n=0}finally{t=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function z(e,n,i){var o=r.trits(e),h=r.trits(n),c=r.trits(i||"9".repeat(81)),f=A(o),v=f.value,d=A(o.slice(f.end)),H=d.value,g=f.end+d.end,w=g+t.HASH_LENGTH,y=w+H,p=new t(27);p.reset(),p.absorb(c,0,c.length),p.absorb(h,0,h.length),p.absorb(o,0,g);var T,F=N(o.slice(g,g+t.HASH_LENGTH),p),_=N(o.slice(w,w+H),p),E=N(o.slice(y,y+t.HASH_LENGTH/3),p),L=s(p),S=0===(T=L).slice(0,t.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?1:0===T.slice(0,2*t.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?2:0===T.reduce((function(e,r){return e+r}),0)?3:0;if(0===S)throw new Error("Message Hash did not have any hamming weight of zero");var G=N(o.slice(y+E.length),p);p.reset();var m=function(e,r){for(var n=new t(27),i=[],o=0;o<r.length/t.HASH_LENGTH;o++){for(var u=r.slice(o*t.HASH_LENGTH,(o+1)*t.HASH_LENGTH),h=0;h<e[3*o]+3*e[3*o+1]+9*e[3*o+2]-l;h++)n.reset(),n.absorb(u,0,u.length),u=s(n);i.push(u)}n.reset();var c=a(i);return n.absorb(c,0,c.length),s(n)}(L,G.slice(0,S*u));p.absorb(m,0,m.length);var I=A(G.slice(S*u)),x=I.value,M=s(p);if(0!==x){var z=S*u+I.end,O=G.slice(z,z+x*t.HASH_LENGTH);M=b.root(M,O,v)}if(r.trytes(M)!==n)throw new Error("Signature did not match expected root");return{nextRoot:r.trytes(F),message:r.trytes(_)}}function O(e,t,n,i){return x(this,void 0,Promise,(function(){var o,s,a,u,l,h,c;return M(this,(function(f){switch(f.label){case 0:return o=function(e,t){if("public"===t)return e;return r.trytes(S(r.trits(e)))}(t,n),[4,e.findTransactionObjects({addresses:[o]})];case 1:if(0===(s=f.sent()).length)return[2];for(a=s.filter((function(e){return 0===e.currentIndex})),u=s.filter((function(e){return 0!==e.currentIndex})),l=function(e){for(var r=a[e].signatureMessageFragment,n=a[e],o=0;o<a[e].lastIndex;o++){var s=u.find((function(e){return e.hash===n.trunkTransaction}));if(!s)break;if(r+=s.signatureMessageFragment,n=s,o===a[e].lastIndex-1)try{var l=z(r,t,i);if(l)return{value:I(I({},l),{tag:a[e].tag})}}catch(e){}}},h=0;h<a.length;h++)if("object"==typeof(c=l(h)))return[2,c.value];return[2]}}))}))}e.channelRoot=function(e){var t=new b(e.seed,e.start,e.count,e.security);return r.trytes(t.root.addressTrits)},e.createChannel=function(e,r,t,i){if(!n.isTrytesOfExactLength(e,81))throw new Error("The seed must be 81 trytes long");if(r<1||r>3)throw new Error("Security must be between 1 and 3, it is "+r);if("public"!==t&&"private"!==t&&"restricted"!==t)throw new Error("The mode must be public, private or restricted, it is '"+t+"'");if("restricted"===t){if(!i)throw new Error("You must provide a sideKey for restricted mode");if(!n.isTrytes(i))throw new Error("The sideKey must be in trytes");if(i.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==t&&i)throw new Error("Sidekey is only used in restricted mode");return{seed:e,mode:t,sideKey:"restricted"===t?(i||"").padEnd(81,"9"):void 0,security:r,start:0,count:1,nextCount:1,index:0}},e.createMessage=function(e,i){if(!n.isTrytes(i))throw new Error("The message must be in trytes");var u=new b(e.seed,e.start,e.count,e.security),l=new b(e.seed,e.start+e.count,e.nextCount,e.security).root.addressTrits,c=r.trits(i),f=T(e.index),v=T(c.length),d=u.getSubtree(e.index),H=new t(27);H.reset();var g=r.trits(e.sideKey||"9".repeat(81));H.absorb(g,0,g.length),H.absorb(u.root.addressTrits,0,u.root.addressTrits.length);var w=a([f,v]);H.absorb(w,0,w.length);var y=G(a([l,c]),H);w=a([w,y]);var p=(new L).search(s(H,o),e.security,t.HASH_LENGTH/3,0);G(p,H),w=a([w,p]);var A=function(e,r){for(var n=new t(27),i=[],o=0;o<r.length/t.HASH_LENGTH;o++){for(var u=r.slice(o*t.HASH_LENGTH,(o+1)*t.HASH_LENGTH),l=0;l<h-(e[3*o]+3*e[3*o+1]+9*e[3*o+2]);l++)n.reset(),n.absorb(u,0,u.length),u=s(n);i.push(u)}return a(i)}(s(H),d.key),F=a(d.leaves.map((function(e){return e.addressTrits}))),_=G(a([A,T(F.length/t.HASH_LENGTH),F]),H),E=(w=a([w,_])).length%3;0!==E&&(w=a([w,new Int8Array(3-E).fill(0)])),H.reset();var N=u.root.addressTrits;"public"!==e.mode&&(N=S(u.root.addressTrits));var m={payload:r.trytes(w),root:r.trytes(u.root.addressTrits),address:r.trytes(N)};return e.index===e.count-1?(e.start=e.nextCount+e.start,e.index=0):e.index++,e.nextRoot=r.trytes(l),m},e.mamAttach=function(e,r,t,n,i){return x(this,void 0,Promise,(function(){var o,s;return M(this,(function(a){switch(a.label){case 0:return o=[{address:r.address,value:0,message:r.payload,tag:i}],[4,e.prepareTransfers("9".repeat(81),o)];case 1:return s=a.sent(),[4,e.sendTrytes(s,t,n)];case 2:return[2,a.sent()]}}))}))},e.mamFetch=O,e.mamFetchAll=function(e,r,t,n,i){return x(this,void 0,Promise,(function(){var o,s,a,u;return M(this,(function(l){switch(l.label){case 0:o=void 0===i?Number.MAX_VALUE:i,s=[],a=r,l.label=1;case 1:return[4,O(e,a,t,n)];case 2:(u=l.sent())?(s.push(u),a=u.nextRoot):a=void 0,l.label=3;case 3:if(a&&s.length<o)return[3,1];l.label=4;case 4:return[2,s]}}))}))},e.parseMessage=z,Object.defineProperty(e,"__esModule",{value:!0})}));
