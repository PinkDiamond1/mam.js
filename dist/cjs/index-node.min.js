!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@iota/crypto.js"),require("@iota/util.js"),require("big-integer"),require("@iota/iota.js")):"function"==typeof define&&define.amd?define(["exports","@iota/crypto.js","@iota/util.js","big-integer","@iota/iota.js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Mam={},t.IotaCrypto,t.IotaUtil,t.bigInt,t.Iota)}(this,(function(t,e,r,n,s){"use strict";function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=o(n);class l{static encodeNonASCII(t){return"string"==typeof t?t.replace(/[\u007F-\uFFFF]/g,(t=>`\\u${`0000${t.charCodeAt(0).toString(16)}`.slice(-4)}`)):void 0}static decodeNonASCII(t){return"string"==typeof t?t.replace(/\\u(\w{4})/gi,((t,e)=>String.fromCharCode(Number.parseInt(e,16)))):void 0}}class a{static isHash(t){return/^[9A-Z]{81}$/.test(t)}static isTag(t){return/^[9A-Z]{27}$/.test(t)}static isTrytes(t){return/^[9A-Z]+$/.test(t)}static toTrits(t){const e=new Int8Array(3*t.length);for(let r=0;r<t.length;r++){const n=a.ALPHABET.indexOf(t.charAt(r));e[3*r]=a.TRYTES_TRITS[n][0],e[3*r+1]=a.TRYTES_TRITS[n][1],e[3*r+2]=a.TRYTES_TRITS[n][2]}return e}static fromTrits(t){let e="";for(let r=0;r<t.length;r+=3)for(let n=0;n<a.ALPHABET.length;n++)if(a.TRYTES_TRITS[n][0]===t[r]&&a.TRYTES_TRITS[n][1]===t[r+1]&&a.TRYTES_TRITS[n][2]===t[r+2]){e+=a.ALPHABET.charAt(n);break}return e}static tritsValue(t){let e=0;for(let r=t.length-1;r>=0;r--)e=3*e+t[r];return e}static fromAscii(t){let e="";for(let r=0;r<t.length;r++){const n=t.charCodeAt(r),s=n%27,o=(n-s)/27;e+=a.ALPHABET[s]+a.ALPHABET[o]}return e}static toAscii(t){const e=t;if(e.length%2==1)throw new Error("The trytes length must be an even number");let r="";for(let t=0;t<e.length;t+=2){const n=a.ALPHABET.indexOf(e[t])+27*a.ALPHABET.indexOf(e[t+1]);r+=String.fromCharCode(n)}return r}static objectToTrytes(t){const e=JSON.stringify(t),r=l.encodeNonASCII(e);return r?a.fromAscii(r):""}static objectFromTrytes(t){if("string"!=typeof t)throw new TypeError("fromTrytes can only convert strings");const e=t.replace(/\9+$/,"");if(0===e.length)throw new Error("fromTrytes trytes does not contain any data");const r=a.toAscii(e),n=l.decodeNonASCII(r);return n?JSON.parse(n):void 0}static stringToTrytes(t){const e=l.encodeNonASCII(t);return e?a.fromAscii(e):""}static stringFromTrytes(t){let e=t.replace(/\9+$/,"");e.length%2==1&&(e+="9");const r=a.toAscii(e);return l.decodeNonASCII(r)}static packTrytes(t){const e=[];for(const r of t)e.push(a.ALPHABET.indexOf(r).toString(2).padStart(5,"0"));let n=e.join("");const s=n.length%8;return s>0&&(n+="1".repeat(8-s)),r.Converter.binaryToBytes(n)}static unpackTrytes(t){const e=r.Converter.bytesToBinary(t),n=[];for(let t=0;t<e.length;t+=5){const r=e.slice(t,t+5);if(r.length<5||"111111"===r)break;n.push(a.ALPHABET[Number.parseInt(r,2)])}return n.join("")}}a.ALPHABET="9ABCDEFGHIJKLMNOPQRSTUVWXYZ",a.TRYTES_TRITS=[new Int8Array([0,0,0]),new Int8Array([1,0,0]),new Int8Array([-1,1,0]),new Int8Array([0,1,0]),new Int8Array([1,1,0]),new Int8Array([-1,-1,1]),new Int8Array([0,-1,1]),new Int8Array([1,-1,1]),new Int8Array([-1,0,1]),new Int8Array([0,0,1]),new Int8Array([1,0,1]),new Int8Array([-1,1,1]),new Int8Array([0,1,1]),new Int8Array([1,1,1]),new Int8Array([-1,-1,-1]),new Int8Array([0,-1,-1]),new Int8Array([1,-1,-1]),new Int8Array([-1,0,-1]),new Int8Array([0,0,-1]),new Int8Array([1,0,-1]),new Int8Array([-1,1,-1]),new Int8Array([0,1,-1]),new Int8Array([1,1,-1]),new Int8Array([-1,-1,0]),new Int8Array([0,-1,0]),new Int8Array([1,-1,0]),new Int8Array([-1,0,0])];const u=27*e.Curl.HASH_LENGTH;function c(t){const r=new e.Curl(27);r.absorb(t,0,t.length);const n=new Int8Array(e.Curl.HASH_LENGTH);return r.squeeze(n,0,n.length),n}function h(t,r){const n=r*u,s=new Int8Array(n),o=new Int8Array(n),i=new e.Curl(27);i.absorb(t,0,t.length),i.squeeze(s,0,s.length);for(let t=0;t<n/e.Curl.HASH_LENGTH;t++){const r=t*e.Curl.HASH_LENGTH;i.reset(),i.absorb(s,r,e.Curl.HASH_LENGTH),o.set(i.rate(),r)}return o}function f(t,r,n){const s=function(t,r){const n=new e.Curl(27),s=t.slice();let o=r;for(;o-- >0;)for(let t=0;t<s.length&&s[t]++>=1;t++)s[t]=-1;n.absorb(s,0,s.length);const i=new Int8Array(e.Curl.HASH_LENGTH);return n.squeeze(i,0,i.length),i}(t,r);return{address:c(function(t,r){const n=new e.Curl(27),s=new e.Curl(27),o=new e.Curl(27),i=r*u/e.Curl.HASH_LENGTH,l=new Int8Array(e.Curl.HASH_LENGTH);n.absorb(t,0,t.length);for(let t=0;t<i;t++){n.squeeze(l,0,l.length);for(let t=0;t<27;t++)s.reset(),s.absorb(l,0,l.length),s.squeeze(l,0,l.length);o.absorb(l,0,l.length)}return o.squeeze(l,0,l.length),l}(s,n)),privateKey:h(s,n)}}class d{constructor(t,e,r,n){this.left=t,this.right=e,this.size=(t?t.size:0)+(e?e.size:0),this.addressTrits=r,this.privateKeyTrits=n}}class T{constructor(t,e,r,n){const s=a.toTrits(t),o=[];for(let t=0;t<r;t++){const r=f(s,e+t,n);o.push(new d(void 0,void 0,r.address,r.privateKey)),o[t].size=1}this.root=this.buildTree(o)}static root(t,r,n){const s=new e.Curl(27);let o=1;const i=Math.ceil(r.length/e.Curl.HASH_LENGTH);for(let l=0;l<i;l++){const i=r.slice(l*e.Curl.HASH_LENGTH,(l+1)*e.Curl.HASH_LENGTH);s.reset(),0==(o&n)?(s.absorb(t,0,t.length),s.absorb(i,0,i.length)):(s.absorb(i,0,i.length),s.absorb(t,0,t.length)),o<<=1,t=s.rate()}return s.rate()}getSubtree(t){var e;if(1===this.root.size)return{key:(null===(e=this.root.left)||void 0===e?void 0:e.privateKeyTrits)?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};const r=[];let n,s=this.root,o=this.root.size;if(t<o)for(;s;){if(!s.left){n=s.privateKeyTrits;break}o=s.left.size,t<o?(r.push(s.right?s.right:s.left),s=s.left):(r.push(s.left),s=s.right,t-=o)}return r.reverse(),{key:null!=n?n:new Int8Array,leaves:r}}buildTree(t){const r=[];for(let n=0;n<t.length;n+=2){const s=t[n],o=n+1<t.length?t[n+1]:void 0;let i;if(o){const t=new e.Curl(27);t.absorb(s.addressTrits,0,s.addressTrits.length),t.absorb(o.addressTrits,0,o.addressTrits.length),i=new Int8Array(e.Curl.HASH_LENGTH),t.squeeze(i,0,i.length)}else i=s.addressTrits;r.push(new d(s,o,i,void 0))}return 1===r.length?r[0]:this.buildTree(r)}}const g=new Int8Array([1,0,0,-1]);function H(t){if(0===t)return g;const e=y(w(Math.abs(t),1)),r=new Int8Array(function(t){const e=y(w(Math.abs(t),1));return e+e/3}(t));E(t,r);let n=0,s=0;for(let t=0;t<e-3;t+=3){const e=r.slice(t,t+3);if(a.tritsValue(e)>=0){n|=1<<s;for(let n=0;n<e.length;n++)r[t+n]=-e[n]}s++}const o=r.slice(e-3,e-3+e);if(a.tritsValue(o)<0){n|=1<<s;for(let t=0;t<o.length;t++)r[t+e-3]=-r[t+e-3]}const i=new Int8Array(r.length-e);E(n,i);for(let t=0;t<i.length;t++)r[e+t]=i[t];return r}function A(t){if(t.length>=g.length&&t[0]===g[0]&&t[1]===g[1]&&t[2]===g[2]&&t[3]===g[3])return{value:0,end:4};const e=b(t),r=e+e/3,n=a.tritsValue(t.slice(e,r));let s=0;for(let r=0;r<e/3;r++){const e=0!=(n>>r&1)?-a.tritsValue(t.slice(3*r,3*(r+1))):a.tritsValue(t.slice(3*r,3*(r+1)));s+=Math.pow(27,r)*e}return{value:s,end:r}}function y(t){const e=t%3;return 0===e?t:t+3-e}function w(t,e){return t<=e?1:1+w(t,1+3*e)}function b(t){return a.tritsValue(t.slice(0,3))>0?3:3+b(t.slice(3))}function E(t,e){const r=C(t,e,0);if(t>=0)return r;for(let t=0;t<e.length;t++)e[t]=-e[t];return r}function C(t,e,r){switch(t){case 0:return 0;default:let n=Math.floor(t/3),s=t%3;return s>1&&(n+=1,s=-1),e[r]=s,1+C(n,e,++r)}}class I{search(t,r,n,s){const o=this.prepareTrits(t,s);let i=Math.min(n,e.Curl.HASH_LENGTH)-s,l=0;for(;0===l;){const t=this.increment(o,s+2*i/3,s+i);i=Math.min(y(s+2*i/3+t),e.Curl.HASH_LENGTH)-s;const n={low:o.low.slice(),high:o.high.slice()};this.transform(n),l=this.check(r,n.low,n.high)}return this.trinaryGet(o.low,o.high,i,l)}prepareTrits(t,r){const n=this.tritsToBigInt(t,e.Curl.STATE_LENGTH);return n.low[r]=I.LOW_0,n.low[r+1]=I.LOW_1,n.low[r+2]=I.LOW_2,n.low[r+3]=I.LOW_3,n.high[r]=I.HIGH_0,n.high[r+1]=I.HIGH_1,n.high[r+2]=I.HIGH_2,n.high[r+3]=I.HIGH_3,n}tritsToBigInt(t,e){const r={low:[],high:[]};for(let e=0;e<t.length;e++)switch(t[e]){case 0:r.low[e]=I.MAX_VALUE,r.high[e]=I.MAX_VALUE;break;case 1:r.low[e]=I.MIN_VALUE,r.high[e]=I.MAX_VALUE;break;default:r.low[e]=I.MAX_VALUE,r.high[e]=I.MIN_VALUE}if(t.length>=e)return r;for(let n=t.length;n<e;n++)r.low[n]=I.MAX_VALUE,r.high[n]=I.MAX_VALUE;return r}increment(t,e,r){for(let n=e;n<r;n++){const s=t.low[n],o=t.high[n];if(t.low[n]=o.xor(s),t.high[n]=s,o.and(s.not()).equals(0))return r-e}return r-e+1}transform(t){let r=0;for(let n=0;n<I.ROUNDS;n++){const n={low:t.low.slice(0,e.Curl.STATE_LENGTH),high:t.high.slice(0,e.Curl.STATE_LENGTH)};for(let s=0;s<e.Curl.STATE_LENGTH;s++){const e=n.low[r],o=n.high[r];r+=r<365?364:-365;const i=n.high[r],l=n.low[r].xor(o),a=this.bitWiseNot(i),u=e.or(a).and(l);t.low[s]=this.bitWiseNot(u);const c=e.xor(i);t.high[s]=c.or(u)}}}bitWiseNot(t){return i.default(1).shiftLeft(64).subtract(i.default(1)).subtract(t)}check(t,e,r){for(let n=0;n<64;n++){let s=0;for(let o=0;o<t;o++){for(let t=243*o/3;t<243*(o+1)/3;t++){const o=i.default(1).shiftLeft(n);e[t].and(o).equals(0)?s--:r[t].and(o).equals(0)&&s++}if(0===s&&o<t-1){s=1;break}}if(0===s)return n}return 0}trinaryGet(t,e,r,n){const s=new Int8Array(r);for(let o=0;o<r;o++){const r=i.default(n),l=t[o].shiftRight(r).and(1),a=e[o].shiftRight(r).and(1);l.equals(1)&&a.equals(0)?s[o]=-1:l.equals(0)&&a.equals(1)?s[o]=1:s[o]=0}return s}}function S(t){let e=0;for(const r of t)e+=r.length;const r=new Int8Array(e);let n=0;for(const e of t)r.set(e,n),n+=e.length;return r}function _(t,e){if("public"!==t&&"private"!==t&&"restricted"!==t)throw new Error(`The mode must be public, private or restricted, it is '${t}'`);if("restricted"===t){if(!e)throw new Error("You must provide a sideKey for restricted mode");if(!a.isTrytes(e))throw new Error("The sideKey must be in trytes");if(e.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==t&&e)throw new Error("sideKey is only used in restricted mode")}function L(t){const r=new e.Curl(81);r.absorb(t,0,t.length);const n=new Int8Array(e.Curl.HASH_LENGTH);return r.squeeze(n,0,n.length),n}function p(t,r){const n=r.rate(),s=Math.ceil(t.length/e.Curl.HASH_LENGTH);for(let o=0;o<s;o++){const s=t.slice(o*e.Curl.HASH_LENGTH,(o+1)*e.Curl.HASH_LENGTH);r.absorb(s,0,s.length);const i=r.rate();for(let r=0;r<s.length;r++)t[o*e.Curl.HASH_LENGTH+r]=m(s[r],n[r]),n[r]=i[r]}return t}function F(t,r){const n=new Int8Array(t),s=Math.ceil(n.length/e.Curl.HASH_LENGTH)*e.Curl.HASH_LENGTH;let o;for(let t=0;t<s;t++){const s=t%e.Curl.HASH_LENGTH;0===s&&(o=r.rate()),o&&(n[t]=m(n[t],-o[s])),s===e.Curl.HASH_LENGTH-1&&r.absorb(n,Math.floor(t/e.Curl.HASH_LENGTH)*e.Curl.HASH_LENGTH,e.Curl.HASH_LENGTH)}return n}function m(t,e){const r=t+e;switch(r){case 2:return-1;case-2:return 1;default:return r}}function N(t,r,n){const s=a.toTrits(t),o=a.toTrits(r),i=a.toTrits(null!=n?n:"9".repeat(81)),l=A(s),c=l.value,h=A(s.slice(l.end)),f=h.value,d=l.end+h.end,g=d+e.Curl.HASH_LENGTH,H=g+f,y=new e.Curl(27);y.absorb(i,0,i.length),y.absorb(o,0,o.length),y.absorb(s,0,d);const w=F(s.slice(d,d+e.Curl.HASH_LENGTH),y),b=F(s.slice(g,g+f),y),E=F(s.slice(H,H+e.Curl.HASH_LENGTH/3),y),C=y.rate(),I=function(t){const r=t.slice(0,e.Curl.HASH_LENGTH/3);let n=0;for(let t=0;t<r.length;t++)n+=r[t];if(0===n)return 1;const s=t.slice(0,2*e.Curl.HASH_LENGTH/3);let o=0;for(let t=0;t<s.length;t++)o+=s[t];if(0===o)return 2;let i=0;for(let e=0;e<t.length;e++)i+=t[e];return 0===i?3:0}(C);if(0===I)throw new Error("Message Hash did not have a hamming weight of zero, security level is invalid");const S=F(s.slice(H+E.length),y);y.reset();const _=function(t,r){const n=new e.Curl(27),s=new Int8Array(r.length);for(let o=0;o<r.length/e.Curl.HASH_LENGTH;o++){let i=r.slice(o*e.Curl.HASH_LENGTH,(o+1)*e.Curl.HASH_LENGTH);for(let e=0;e<t[3*o]+3*t[3*o+1]+9*t[3*o+2]- -13;e++)n.reset(),n.absorb(i,0,i.length),i=n.rate();s.set(i,o*e.Curl.HASH_LENGTH)}return n.reset(),n.absorb(s,0,s.length),n.rate()}(C,S.slice(0,I*u));y.absorb(_,0,_.length);const L=A(S.slice(I*u)),p=L.value;let m=y.rate();if(0!==p){const t=I*u+L.end,r=S.slice(t,t+p*e.Curl.HASH_LENGTH);m=T.root(m,r,c)}if(a.fromTrits(m)!==r)throw new Error("Signature did not match expected root");return{nextRoot:a.fromTrits(w),message:a.fromTrits(b)}}async function G(t,n,o,i){_(o,i);const l="string"==typeof t?new s.SingleNodeClient(t):t,a=v(n,o),u=e.Blake2b.sum256(r.Converter.utf8ToBytes(a));try{const t=await l.messagesFind(u),e=[];for(const r of t.messageIds)try{const t=await l.message(r);e.push(t)}catch{}return await B(e,n,i)}catch{}}function v(t,e){return"public"===e?t:a.fromTrits(L(a.toTrits(t)))}async function B(t,e,n){var o;if(t&&0!==t.length)for(const i of t)if((null===(o=i.payload)||void 0===o?void 0:o.type)===s.INDEXATION_PAYLOAD_TYPE&&i.payload.data){const t=r.Converter.hexToBytes(i.payload.data);if(t.length>100){const r=t[0],s=r>0?t.slice(1,1+r):void 0,o=t.slice(1+r),i=s?a.unpackTrytes(s):"",l=a.unpackTrytes(o);try{return{root:e,...N(l,e,n),tag:i}}catch{}}}}I.MAX_VALUE=i.default("FFFFFFFFFFFFFFFF",16),I.MIN_VALUE=i.default("0000000000000000",16),I.HIGH_0=i.default("B6DB6DB6DB6DB6DB",16),I.HIGH_1=i.default("8FC7E3F1F8FC7E3F",16),I.HIGH_2=i.default("FFC01FFFF803FFFF",16),I.HIGH_3=i.default("003FFFFFFFFFFFFF",16),I.LOW_0=i.default("DB6DB6DB6DB6DB6D",16),I.LOW_1=i.default("F1F8FC7E3F1F8FC7",16),I.LOW_2=i.default("7FFFE00FFFFC01FF",16),I.LOW_3=i.default("FFC0000007FFFFFF",16),I.ROUNDS=27,t.TrytesHelper=a,t.channelRoot=function(t){if(!t)throw new Error("channelState must be provided");if(t.start<0)throw new Error("channelState.start must be >= 0");if(t.count<=0)throw new Error("channelState.count must be > 0");if(t.security<1||t.security>3)throw new Error(`channelState.security must be between 1 and 3, it is ${t.security}`);const e=new T(t.seed,t.start,t.count,t.security);return a.fromTrits(e.root.addressTrits)},t.createChannel=function(t,e,r,n){if(!a.isHash(t))throw new Error("The seed must be 81 trytes long");if(e<1||e>3)throw new Error(`Security must be between 1 and 3, it is ${e}`);return _(r,n),{seed:t,mode:r,sideKey:"restricted"===r?(null!=n?n:"").padEnd(81,"9"):void 0,security:e,start:0,count:1,nextCount:1,index:0}},t.createMessage=function(t,r){var n;if(!a.isTrytes(r))throw new Error("The message must be in trytes");const s=new T(t.seed,t.start,t.count,t.security),o=new T(t.seed,t.start+t.count,t.nextCount,t.security).root.addressTrits,i=a.toTrits(r),l=H(t.index),u=H(i.length),c=s.getSubtree(t.index),h=new e.Curl(27),f=a.toTrits(null!==(n=t.sideKey)&&void 0!==n?n:"9".repeat(81));h.absorb(f,0,f.length),h.absorb(s.root.addressTrits,0,s.root.addressTrits.length);let d=S([l,u]);h.absorb(d,0,d.length);const g=p(S([o,i]),h);d=S([d,g]);const A=(new I).search(h.rate(e.Curl.STATE_LENGTH),t.security,e.Curl.HASH_LENGTH/3,0);p(A,h),d=S([d,A]);const y=function(t,r){const n=new Int8Array(r.length),s=new e.Curl(27);for(let o=0;o<r.length/e.Curl.HASH_LENGTH;o++){let i=r.subarray(o*e.Curl.HASH_LENGTH,(o+1)*e.Curl.HASH_LENGTH);for(let e=0;e<13-(t[3*o]+3*t[3*o+1]+9*t[3*o+2]);e++)s.reset(),s.absorb(i,0,i.length),i=s.rate();n.set(i,o*e.Curl.HASH_LENGTH)}return n}(h.rate(),c.key),w=S(c.leaves.map((t=>t.addressTrits))),b=p(S([y,H(w.length/e.Curl.HASH_LENGTH),w]),h);d=S([d,b]);const E=d.length%3;0!==E&&(d=S([d,new Int8Array(3-E).fill(0)]));const C="public"===t.mode?s.root.addressTrits:L(s.root.addressTrits),_={payload:a.fromTrits(d),root:a.fromTrits(s.root.addressTrits),address:a.fromTrits(C)};return t.index===t.count-1?(t.start=t.nextCount+t.start,t.index=0):t.index++,t.nextRoot=a.fromTrits(o),_},t.decodeAddress=v,t.decodeMessages=B,t.mamAttach=async function(t,n,o){if(void 0!==o&&"string"!=typeof o)throw new Error("MWM and depth are no longer needed when calling mamAttach");if((o?o.length:0)>27)throw new Error("The tag length is too long");const i=o?a.packTrytes(o):void 0,l=i?i.length:0,u=a.packTrytes(n.payload),c=new Uint8Array(1+l+u.length);c[0]=l,i&&c.set(i,1),c.set(u,1+l);const h=e.Blake2b.sum256(r.Converter.utf8ToBytes(n.address)),f={payload:{type:s.INDEXATION_PAYLOAD_TYPE,index:r.Converter.bytesToHex(h),data:r.Converter.bytesToHex(c)}},d="string"==typeof t?new s.SingleNodeClient(t):t;return{message:f,messageId:await d.messageSubmit(f)}},t.mamFetch=G,t.mamFetchAll=async function(t,e,r,n,o){const i="string"==typeof t?new s.SingleNodeClient(t):t;_(r,n);const l=void 0===o?Number.MAX_VALUE:o,a=[];let u=e;do{const t=await G(i,u,r,n);t?(a.push(t),u=t.nextRoot):u=void 0}while(u&&a.length<l);return a},t.parseMessage=N,Object.defineProperty(t,"__esModule",{value:!0})}));